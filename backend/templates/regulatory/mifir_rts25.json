{
  "id": "mifir-rts25-v1",
  "name": "MiFIR RTS 25 Transaction Report",
  "description": "Daily transaction reporting per MiFIR RTS 25 requirements. Complete 65-field specification covering all transaction details.",
  "regulation": "MiFIR",
  "version": "1.0.0",
  "category": "transaction_reporting",
  "config": {
    "mode": "simple",
    "output_format": "xml",
    "output_filename_template": "MIFIR_{business_date_from}_{job_run_id}",
    "query_sql": "SELECT * FROM vw_cdm_trade_data WHERE trade_date = '{business_date_from}'::date ORDER BY execution_timestamp",
    "xml": {
      "pretty_print": true,
      "include_declaration": true,
      "root_element": "Document",
      "row_element": "Tx",
      "header": {
        "message_type": "auth.016",
        "description": "MiFIR Transaction Report (auth.016.001.01)",
        "namespace": "urn:iso:std:iso:20022:tech:xsd:auth.016.001.01",
        "include_record_count": true,
        "include_pagination": false,
        "reporting_party_lei": "",
        "competent_authority_country": ""
      }
    },
    "field_mappings": [
      {
        "sourceColumn": "transaction_reference_number",
        "targetXPath": "/Report/Tx/TxId",
        "transform": "",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 1: Unique transaction reference number"
      },
      {
        "sourceColumn": "trading_venue_transaction_id",
        "targetXPath": "/Report/Tx/TradVnTxId",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 2: Trading venue transaction identification code"
      },
      {
        "sourceColumn": "executing_entity_id_code",
        "targetXPath": "/Report/Tx/ExctgPty",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 3: Executing entity identification code (LEI)"
      },
      {
        "sourceColumn": "investment_firm_covered_mifid",
        "targetXPath": "/Report/Tx/InvstmtPtyInd",
        "transform": "BOOLEAN_TF",
        "defaultValue": "true",
        "required": true,
        "documentation": "Field 4: Investment firm indicator"
      },
      {
        "sourceColumn": "buyer_id_code_type",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/Id/Tp",
        "transform": "",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 5: Buyer identification code type"
      },
      {
        "sourceColumn": "buyer_id_code",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/Id/Id",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 6: Buyer identification code"
      },
      {
        "sourceColumn": "buyer_country_of_branch",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 7: Country of the branch for the buyer"
      },
      {
        "sourceColumn": "buyer_first_name",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/FrstNm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 8: Buyer first name(s)"
      },
      {
        "sourceColumn": "buyer_surname",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/Nm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 9: Buyer surname(s)"
      },
      {
        "sourceColumn": "buyer_date_of_birth",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/BirthDt",
        "transform": "DATE_ISO",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 10: Buyer date of birth"
      },
      {
        "sourceColumn": "buyer_lei",
        "targetXPath": "/Report/Tx/Buyr/AcctOwnr/LEI",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 11: Buyer LEI code"
      },
      {
        "sourceColumn": "buyer_decision_maker_code",
        "targetXPath": "/Report/Tx/Buyr/DcsnMkr/Id",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 12: Buyer decision maker code"
      },
      {
        "sourceColumn": "buyer_decision_maker_country",
        "targetXPath": "/Report/Tx/Buyr/DcsnMkr/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 13: Country of the branch for buyer decision maker"
      },
      {
        "sourceColumn": "buyer_decision_maker_first_name",
        "targetXPath": "/Report/Tx/Buyr/DcsnMkr/FrstNm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 14: Buyer decision maker first name"
      },
      {
        "sourceColumn": "buyer_decision_maker_surname",
        "targetXPath": "/Report/Tx/Buyr/DcsnMkr/Nm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 15: Buyer decision maker surname"
      },
      {
        "sourceColumn": "buyer_decision_maker_dob",
        "targetXPath": "/Report/Tx/Buyr/DcsnMkr/BirthDt",
        "transform": "DATE_ISO",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 16: Buyer decision maker date of birth"
      },
      {
        "sourceColumn": "seller_id_code_type",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/Id/Tp",
        "transform": "",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 17: Seller identification code type"
      },
      {
        "sourceColumn": "seller_id_code",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/Id/Id",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 18: Seller identification code"
      },
      {
        "sourceColumn": "seller_country_of_branch",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 19: Country of the branch for the seller"
      },
      {
        "sourceColumn": "seller_first_name",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/FrstNm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 20: Seller first name(s)"
      },
      {
        "sourceColumn": "seller_surname",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/Nm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 21: Seller surname(s)"
      },
      {
        "sourceColumn": "seller_date_of_birth",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/BirthDt",
        "transform": "DATE_ISO",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 22: Seller date of birth"
      },
      {
        "sourceColumn": "seller_lei",
        "targetXPath": "/Report/Tx/Sellr/AcctOwnr/LEI",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 23: Seller LEI code"
      },
      {
        "sourceColumn": "seller_decision_maker_code",
        "targetXPath": "/Report/Tx/Sellr/DcsnMkr/Id",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 24: Seller decision maker code"
      },
      {
        "sourceColumn": "seller_decision_maker_country",
        "targetXPath": "/Report/Tx/Sellr/DcsnMkr/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 25: Country of the branch for seller decision maker"
      },
      {
        "sourceColumn": "seller_decision_maker_first_name",
        "targetXPath": "/Report/Tx/Sellr/DcsnMkr/FrstNm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 26: Seller decision maker first name"
      },
      {
        "sourceColumn": "seller_decision_maker_surname",
        "targetXPath": "/Report/Tx/Sellr/DcsnMkr/Nm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 27: Seller decision maker surname"
      },
      {
        "sourceColumn": "seller_decision_maker_dob",
        "targetXPath": "/Report/Tx/Sellr/DcsnMkr/BirthDt",
        "transform": "DATE_ISO",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 28: Seller decision maker date of birth"
      },
      {
        "sourceColumn": "transmission_of_order_indicator",
        "targetXPath": "/Report/Tx/OrdrTrnsmssn/TrnsmssnInd",
        "transform": "BOOLEAN_TF",
        "defaultValue": "false",
        "required": true,
        "documentation": "Field 29: Transmission of order indicator"
      },
      {
        "sourceColumn": "transmitting_firm_id_buyer",
        "targetXPath": "/Report/Tx/OrdrTrnsmssn/TrnsmttgBuyr",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 30: Transmitting firm identification code for the buyer"
      },
      {
        "sourceColumn": "transmitting_firm_id_seller",
        "targetXPath": "/Report/Tx/OrdrTrnsmssn/TrnsmttgSellr",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 31: Transmitting firm identification code for the seller"
      },
      {
        "sourceColumn": "trading_date_time",
        "targetXPath": "/Report/Tx/TradDt",
        "transform": "DATE_ISO",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 32: Trading date and time"
      },
      {
        "sourceColumn": "trading_capacity",
        "targetXPath": "/Report/Tx/TradgCpcty",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 33: Trading capacity (DEAL, MTCH, AOTC)"
      },
      {
        "sourceColumn": "quantity",
        "targetXPath": "/Report/Tx/Qty",
        "transform": "DECIMAL_4",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 34: Quantity"
      },
      {
        "sourceColumn": "quantity_currency",
        "targetXPath": "/Report/Tx/QtyCcy",
        "transform": "UPPER",
        "defaultValue": "UNIT",
        "required": false,
        "documentation": "Field 35: Quantity currency"
      },
      {
        "sourceColumn": "derivative_notional_change",
        "targetXPath": "/Report/Tx/DerivNtnlChng",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 36: Derivative notional increase/decrease"
      },
      {
        "sourceColumn": "price",
        "targetXPath": "/Report/Tx/Pric/Amt",
        "transform": "DECIMAL_4",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 37: Price"
      },
      {
        "sourceColumn": "price_currency",
        "targetXPath": "/Report/Tx/Pric/Ccy",
        "transform": "UPPER",
        "defaultValue": "EUR",
        "required": true,
        "documentation": "Field 38: Price currency"
      },
      {
        "sourceColumn": "net_amount",
        "targetXPath": "/Report/Tx/NetAmt",
        "transform": "DECIMAL_2",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 39: Net amount"
      },
      {
        "sourceColumn": "venue",
        "targetXPath": "/Report/Tx/TradVn",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 40: Venue (MIC code)"
      },
      {
        "sourceColumn": "country_of_branch_membership",
        "targetXPath": "/Report/Tx/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 41: Country of the branch membership"
      },
      {
        "sourceColumn": "upfront_payment",
        "targetXPath": "/Report/Tx/UpFrntPmt/Amt",
        "transform": "DECIMAL_2",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 42: Up-front payment"
      },
      {
        "sourceColumn": "upfront_payment_currency",
        "targetXPath": "/Report/Tx/UpFrntPmt/Ccy",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 43: Up-front payment currency"
      },
      {
        "sourceColumn": "instrument_id_code_type",
        "targetXPath": "/Report/Tx/FinInstrm/Id/Tp",
        "transform": "UPPER",
        "defaultValue": "ISIN",
        "required": true,
        "documentation": "Field 44: Instrument identification code type"
      },
      {
        "sourceColumn": "instrument_id_code",
        "targetXPath": "/Report/Tx/FinInstrm/Id/Id",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 45: Instrument identification code (ISIN)"
      },
      {
        "sourceColumn": "instrument_full_name",
        "targetXPath": "/Report/Tx/FinInstrm/FullNm",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 46: Instrument full name"
      },
      {
        "sourceColumn": "instrument_classification",
        "targetXPath": "/Report/Tx/FinInstrm/ClssfctnTp",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 47: Instrument classification (CFI code)"
      },
      {
        "sourceColumn": "notional_currency_1",
        "targetXPath": "/Report/Tx/FinInstrm/NtnlCcy1",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 48: Notional currency 1"
      },
      {
        "sourceColumn": "notional_currency_2",
        "targetXPath": "/Report/Tx/FinInstrm/NtnlCcy2",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 49: Notional currency 2"
      },
      {
        "sourceColumn": "price_multiplier",
        "targetXPath": "/Report/Tx/FinInstrm/PricMltplr",
        "transform": "DECIMAL_4",
        "defaultValue": "1",
        "required": false,
        "documentation": "Field 50: Price multiplier"
      },
      {
        "sourceColumn": "underlying_instrument_code",
        "targetXPath": "/Report/Tx/FinInstrm/UndrlygInstrm",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 51: Underlying instrument code"
      },
      {
        "sourceColumn": "underlying_index_name",
        "targetXPath": "/Report/Tx/FinInstrm/UndrlygIndx",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 52: Underlying index name"
      },
      {
        "sourceColumn": "underlying_index_term",
        "targetXPath": "/Report/Tx/FinInstrm/UndrlygIndxTrm",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 53: Term of the underlying index"
      },
      {
        "sourceColumn": "investment_decision_within_firm",
        "targetXPath": "/Report/Tx/InvstmtDcsnPrsn/Id",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 54: Investment decision within firm"
      },
      {
        "sourceColumn": "investment_decision_country",
        "targetXPath": "/Report/Tx/InvstmtDcsnPrsn/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 55: Country of the branch supervising investment decision"
      },
      {
        "sourceColumn": "execution_within_firm",
        "targetXPath": "/Report/Tx/ExctnPrsn/Id",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 56: Execution within firm"
      },
      {
        "sourceColumn": "execution_country",
        "targetXPath": "/Report/Tx/ExctnPrsn/CtryOfBrnch",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 57: Country of the branch supervising execution"
      },
      {
        "sourceColumn": "waiver_indicator",
        "targetXPath": "/Report/Tx/WvrInd",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 58: Waiver indicator"
      },
      {
        "sourceColumn": "short_selling_indicator",
        "targetXPath": "/Report/Tx/ShrtSellgInd",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 59: Short selling indicator"
      },
      {
        "sourceColumn": "otc_post_trade_indicator",
        "targetXPath": "/Report/Tx/OTCPstTradInd",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 60: OTC post-trade indicator"
      },
      {
        "sourceColumn": "commodity_derivative_indicator",
        "targetXPath": "/Report/Tx/CmmdtyDerivInd",
        "transform": "UPPER",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 61: Commodity derivative indicator"
      },
      {
        "sourceColumn": "securities_financing_transaction_indicator",
        "targetXPath": "/Report/Tx/SctiesFincgTxInd",
        "transform": "BOOLEAN_TF",
        "defaultValue": "false",
        "required": false,
        "documentation": "Field 62: Securities financing transaction indicator"
      },
      {
        "sourceColumn": "report_status",
        "targetXPath": "/Report/Tx/RptSts",
        "transform": "UPPER",
        "defaultValue": "NEWT",
        "required": true,
        "documentation": "Field 63: Report status (NEWT, CANC, AMND)"
      },
      {
        "sourceColumn": "linked_transaction_reference",
        "targetXPath": "/Report/Tx/LkTxId",
        "transform": "",
        "defaultValue": "",
        "required": false,
        "documentation": "Field 64: Linked transaction reference (for CANC/AMND)"
      },
      {
        "sourceColumn": "submitting_entity_id_code",
        "targetXPath": "/Report/Tx/SubmitgPty",
        "transform": "UPPER",
        "defaultValue": "",
        "required": true,
        "documentation": "Field 65: Submitting entity identification code (LEI)"
      }
    ],
    "validation_rules": [
      {
        "rule_id": "MIFIR-VR001",
        "name": "LEI Format",
        "expression": "df['executing_entity_id_code'].str.match(r'^[A-Z0-9]{20}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Invalid LEI format for executing entity. Must be 20 alphanumeric characters."
      },
      {
        "rule_id": "MIFIR-VR002",
        "name": "LEI Checksum",
        "expression": "df['executing_entity_id_code'].apply(lei_checksum_valid)",
        "severity": "BLOCKING",
        "error_message": "LEI checksum validation failed for executing entity."
      },
      {
        "rule_id": "MIFIR-VR003",
        "name": "Submitting Entity LEI Format",
        "expression": "df['submitting_entity_id_code'].str.match(r'^[A-Z0-9]{20}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Invalid LEI format for submitting entity."
      },
      {
        "rule_id": "MIFIR-VR004",
        "name": "ISIN Format",
        "expression": "df['instrument_id_code'].str.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', na=True) | (df['instrument_id_code_type'] != 'ISIN')",
        "severity": "BLOCKING",
        "error_message": "Invalid ISIN format. Must be 2 letter country + 9 alphanumeric + 1 check digit."
      },
      {
        "rule_id": "MIFIR-VR005",
        "name": "ISIN Checksum",
        "expression": "df.apply(lambda r: r['instrument_id_code_type'] != 'ISIN' or isin_checksum_valid(r['instrument_id_code']), axis=1)",
        "severity": "BLOCKING",
        "error_message": "ISIN checksum validation failed."
      },
      {
        "rule_id": "MIFIR-VR006",
        "name": "MIC Format",
        "expression": "df['venue'].str.match(r'^[A-Z0-9]{4}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Invalid MIC format. Must be 4 uppercase alphanumeric."
      },
      {
        "rule_id": "MIFIR-VR007",
        "name": "Valid MIC Code",
        "expression": "df['venue'].isin(VALID_MICS) | df['venue'].isin(['XOFF', 'XXXX', 'SINT'])",
        "severity": "WARNING",
        "error_message": "MIC code not found in ISO 10383 registry."
      },
      {
        "rule_id": "MIFIR-VR008",
        "name": "Currency Code Format",
        "expression": "df['price_currency'].str.match(r'^[A-Z]{3}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Invalid currency code format."
      },
      {
        "rule_id": "MIFIR-VR009",
        "name": "Valid Currency Code",
        "expression": "df['price_currency'].isin(ISO_4217_CURRENCIES)",
        "severity": "BLOCKING",
        "error_message": "Currency code not in ISO 4217."
      },
      {
        "rule_id": "MIFIR-VR010",
        "name": "Country Code Format",
        "expression": "df['buyer_country_of_branch'].isna() | df['buyer_country_of_branch'].str.match(r'^[A-Z]{2}$', na=True)",
        "severity": "BLOCKING",
        "error_message": "Invalid country code format."
      },
      {
        "rule_id": "MIFIR-VR011",
        "name": "Valid Country Code",
        "expression": "df['buyer_country_of_branch'].isna() | df['buyer_country_of_branch'].isin(ISO_3166_COUNTRIES)",
        "severity": "BLOCKING",
        "error_message": "Country code not in ISO 3166-1."
      },
      {
        "rule_id": "MIFIR-VR012",
        "name": "CFI Code Format",
        "expression": "df['instrument_classification'].isna() | df['instrument_classification'].str.match(r'^[A-Z]{6}$', na=True)",
        "severity": "BLOCKING",
        "error_message": "Invalid CFI code format. Must be 6 uppercase letters."
      },
      {
        "rule_id": "MIFIR-VR013",
        "name": "Positive Quantity",
        "expression": "pd.to_numeric(df['quantity'], errors='coerce') > 0",
        "severity": "BLOCKING",
        "error_message": "Quantity must be positive."
      },
      {
        "rule_id": "MIFIR-VR014",
        "name": "Non-Negative Price",
        "expression": "pd.to_numeric(df['price'], errors='coerce') >= 0",
        "severity": "BLOCKING",
        "error_message": "Price must be non-negative."
      },
      {
        "rule_id": "MIFIR-VR015",
        "name": "Valid Report Status",
        "expression": "df['report_status'].isin(['NEWT', 'CANC', 'AMND'])",
        "severity": "BLOCKING",
        "error_message": "Invalid report status. Must be NEWT, CANC, or AMND."
      },
      {
        "rule_id": "MIFIR-VR016",
        "name": "Valid Trading Capacity",
        "expression": "df['trading_capacity'].isin(['DEAL', 'MTCH', 'AOTC', 'APTS'])",
        "severity": "BLOCKING",
        "error_message": "Invalid trading capacity. Must be DEAL, MTCH, or AOTC."
      },
      {
        "rule_id": "MIFIR-VR017",
        "name": "Valid Buy/Sell Indicator",
        "expression": "df['buy_sell_indicator'].isin(['BUYI', 'SELL']) if 'buy_sell_indicator' in df.columns else True",
        "severity": "BLOCKING",
        "error_message": "Invalid buy/sell indicator. Must be BUYI or SELL."
      },
      {
        "rule_id": "MIFIR-VR018",
        "name": "Valid Price Notation",
        "expression": "df['price_notation'].isna() | df['price_notation'].isin(['MONE', 'PERC', 'YIEL', 'BAPO'])",
        "severity": "BLOCKING",
        "error_message": "Invalid price notation."
      },
      {
        "rule_id": "MIFIR-VR019",
        "name": "Trading DateTime Format",
        "expression": "df['trading_date_time'].str.match(r'^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}', na=False)",
        "severity": "BLOCKING",
        "error_message": "Invalid trading datetime format. Must be ISO 8601."
      },
      {
        "rule_id": "MIFIR-VR020",
        "name": "Trading Time Not Future",
        "expression": "pd.to_datetime(df['trading_date_time'], errors='coerce') <= pd.Timestamp.utcnow()",
        "severity": "BLOCKING",
        "error_message": "Trading time cannot be in the future."
      },
      {
        "rule_id": "MIFIR-VR021",
        "name": "Buyer Seller Different",
        "expression": "(df['buyer_id_code'] != df['seller_id_code']) | (df['buyer_id_code_type'] != df['seller_id_code_type'])",
        "severity": "BLOCKING",
        "error_message": "Buyer and seller cannot be the same entity."
      },
      {
        "rule_id": "MIFIR-VR022",
        "name": "Linked Transaction for Cancel/Amend",
        "expression": "(df['report_status'] == 'NEWT') | (df['linked_transaction_reference'].notna())",
        "severity": "BLOCKING",
        "error_message": "Linked transaction reference required for CANC/AMND."
      },
      {
        "rule_id": "MIFIR-VR023",
        "name": "Short Selling Only for Sell",
        "expression": "df['short_selling_indicator'].isna() | (df['buy_sell_indicator'] == 'SELL')",
        "severity": "BLOCKING",
        "error_message": "Short selling indicator only valid for sell transactions."
      },
      {
        "rule_id": "MIFIR-VR024",
        "name": "Quantity Currency Required for Monetary",
        "expression": "df['quantity_currency'].notna() | (df['price_notation'] != 'MONE')",
        "severity": "BLOCKING",
        "error_message": "Quantity currency required for monetary notation."
      },
      {
        "rule_id": "MIFIR-VR025",
        "name": "Valid Waiver Indicator",
        "expression": "df['waiver_indicator'].isna() | df['waiver_indicator'].isin(['OILQ', 'NLIQ', 'PRIC', 'SIZE', 'RFPT', 'BENC', 'ILQD', 'RPRI', 'TNCP'])",
        "severity": "BLOCKING",
        "error_message": "Invalid waiver indicator code."
      },
      {
        "rule_id": "MIFIR-VR026",
        "name": "Venue Transaction ID for On-Venue",
        "expression": "df['venue'].isin(['XOFF', 'XXXX', 'SINT']) | df['trading_venue_transaction_id'].notna()",
        "severity": "BLOCKING",
        "error_message": "Trading venue transaction ID required for on-venue trades."
      },
      {
        "rule_id": "MIFIR-VR027",
        "name": "Instrument Full Name for Non-ISIN",
        "expression": "(df['instrument_id_code_type'] == 'ISIN') | df['instrument_full_name'].notna()",
        "severity": "BLOCKING",
        "error_message": "Instrument full name required when ISIN not available."
      },
      {
        "rule_id": "MIFIR-VR028",
        "name": "Valid Short Selling Indicator",
        "expression": "df['short_selling_indicator'].isna() | df['short_selling_indicator'].isin(['SESH', 'SSEX', 'SELL', 'UNDI'])",
        "severity": "BLOCKING",
        "error_message": "Invalid short selling indicator."
      },
      {
        "rule_id": "MIFIR-VR029",
        "name": "Buyer LEI Format When Type is LEI",
        "expression": "(df['buyer_id_code_type'] != 'LEI') | df['buyer_id_code'].str.match(r'^[A-Z0-9]{20}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Buyer ID must be valid LEI format when ID type is LEI."
      },
      {
        "rule_id": "MIFIR-VR030",
        "name": "Seller LEI Format When Type is LEI",
        "expression": "(df['seller_id_code_type'] != 'LEI') | df['seller_id_code'].str.match(r'^[A-Z0-9]{20}$', na=False)",
        "severity": "BLOCKING",
        "error_message": "Seller ID must be valid LEI format when ID type is LEI."
      },
      {
        "rule_id": "MIFIR-VR031",
        "name": "Reasonable Price Range",
        "expression": "pd.to_numeric(df['price'], errors='coerce') < 1e12",
        "severity": "WARNING",
        "error_message": "Price appears unusually high."
      },
      {
        "rule_id": "MIFIR-VR032",
        "name": "Reasonable Quantity Range",
        "expression": "pd.to_numeric(df['quantity'], errors='coerce') < 1e15",
        "severity": "WARNING",
        "error_message": "Quantity appears unusually high."
      },
      {
        "rule_id": "MIFIR-VR033",
        "name": "T+1 Reporting Check",
        "expression": "(pd.Timestamp.utcnow() - pd.to_datetime(df['trading_date_time'], errors='coerce')).dt.days <= 1",
        "severity": "WARNING",
        "error_message": "Report may be late - T+1 deadline applies."
      },
      {
        "rule_id": "MIFIR-VR034",
        "name": "Valid Buyer ID Type",
        "expression": "df['buyer_id_code_type'].isin(['LEI', 'MIC', 'INTC', 'NATI', 'CCPT', 'CONCAT', 'NIDN'])",
        "severity": "BLOCKING",
        "error_message": "Invalid buyer ID type."
      },
      {
        "rule_id": "MIFIR-VR035",
        "name": "Valid Seller ID Type",
        "expression": "df['seller_id_code_type'].isin(['LEI', 'MIC', 'INTC', 'NATI', 'CCPT', 'CONCAT', 'NIDN'])",
        "severity": "BLOCKING",
        "error_message": "Invalid seller ID type."
      }
    ]
  },
  "documentation_url": "https://docs.openreg.io/templates/mifir"
}
