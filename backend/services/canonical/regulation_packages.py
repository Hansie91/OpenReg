"""
Regulation Packages

Pre-built regulation packages for EMIR, MiFIR, and SFTR reporting.
Each package contains:
1. Report template definition
2. Field specifications with validation rules
3. Canonical model mappings
4. Output format configuration
5. Regulatory metadata

These packages can be imported to quickly set up compliant regulatory reporting.
"""

import logging
from datetime import datetime, date
from typing import Dict, List, Optional, Any
from uuid import UUID, uuid4
from dataclasses import dataclass, field
from enum import Enum

logger = logging.getLogger(__name__)


# === Package Data Structures ===

class FieldRequirement(str, Enum):
    """Field requirement levels."""
    MANDATORY = "mandatory"  # Always required
    CONDITIONAL = "conditional"  # Required under certain conditions
    OPTIONAL = "optional"  # Never required


class FieldDataType(str, Enum):
    """Field data types."""
    STRING = "string"
    INTEGER = "integer"
    DECIMAL = "decimal"
    DATE = "date"
    DATETIME = "datetime"
    BOOLEAN = "boolean"
    ENUM = "enum"


@dataclass
class FieldSpec:
    """Specification for a regulatory report field."""
    field_id: str  # Regulatory field ID (e.g., "1", "2.1")
    field_name: str  # Human-readable name
    description: str
    data_type: FieldDataType
    requirement: FieldRequirement
    max_length: Optional[int] = None
    min_length: Optional[int] = None
    pattern: Optional[str] = None  # Regex pattern
    enum_values: Optional[List[str]] = None
    condition: Optional[str] = None  # Condition for CONDITIONAL fields
    canonical_path: Optional[str] = None  # Path in canonical model
    transform: Optional[str] = None  # Transformation to apply
    default_value: Optional[str] = None
    xml_element: Optional[str] = None  # XML element name for output
    validation_rules: List[str] = field(default_factory=list)

    def to_dict(self) -> dict:
        return {
            "field_id": self.field_id,
            "field_name": self.field_name,
            "description": self.description,
            "data_type": self.data_type.value,
            "requirement": self.requirement.value,
            "max_length": self.max_length,
            "min_length": self.min_length,
            "pattern": self.pattern,
            "enum_values": self.enum_values,
            "condition": self.condition,
            "canonical_path": self.canonical_path,
            "transform": self.transform,
            "default_value": self.default_value,
            "xml_element": self.xml_element,
            "validation_rules": self.validation_rules,
        }


@dataclass
class ValidationRuleSpec:
    """Specification for a validation rule."""
    rule_id: str
    name: str
    description: str
    severity: str  # ERROR, WARNING, INFO
    rule_type: str  # format, required, cross_field, business
    expression: str  # Python expression or SQL
    error_message: str
    affected_fields: List[str] = field(default_factory=list)

    def to_dict(self) -> dict:
        return {
            "rule_id": self.rule_id,
            "name": self.name,
            "description": self.description,
            "severity": self.severity,
            "rule_type": self.rule_type,
            "expression": self.expression,
            "error_message": self.error_message,
            "affected_fields": self.affected_fields,
        }


@dataclass
class RegulationPackage:
    """Complete regulation package definition."""
    package_id: str
    regulation_code: str  # EMIR, MIFIR, SFTR
    regulation_name: str
    version: str
    effective_date: str
    description: str
    jurisdiction: str
    reporting_authority: str

    # Field specifications
    fields: List[FieldSpec] = field(default_factory=list)

    # Validation rules
    validation_rules: List[ValidationRuleSpec] = field(default_factory=list)

    # Output configuration
    output_format: str = "XML"  # XML, JSON, CSV
    output_schema: Optional[str] = None  # XSD schema URL
    output_namespace: Optional[str] = None  # XML namespace
    output_root_element: Optional[str] = None

    # Metadata
    created_at: str = field(default_factory=lambda: datetime.utcnow().isoformat())
    tags: List[str] = field(default_factory=list)

    def to_dict(self) -> dict:
        return {
            "package_id": self.package_id,
            "regulation_code": self.regulation_code,
            "regulation_name": self.regulation_name,
            "version": self.version,
            "effective_date": self.effective_date,
            "description": self.description,
            "jurisdiction": self.jurisdiction,
            "reporting_authority": self.reporting_authority,
            "field_count": len(self.fields),
            "validation_rule_count": len(self.validation_rules),
            "output_format": self.output_format,
            "output_schema": self.output_schema,
            "output_namespace": self.output_namespace,
            "output_root_element": self.output_root_element,
            "created_at": self.created_at,
            "tags": self.tags,
            "fields": [f.to_dict() for f in self.fields],
            "validation_rules": [r.to_dict() for r in self.validation_rules],
        }

    def get_summary(self) -> dict:
        """Get package summary without full field details."""
        mandatory_fields = len([f for f in self.fields if f.requirement == FieldRequirement.MANDATORY])
        conditional_fields = len([f for f in self.fields if f.requirement == FieldRequirement.CONDITIONAL])
        optional_fields = len([f for f in self.fields if f.requirement == FieldRequirement.OPTIONAL])

        return {
            "package_id": self.package_id,
            "regulation_code": self.regulation_code,
            "regulation_name": self.regulation_name,
            "version": self.version,
            "effective_date": self.effective_date,
            "description": self.description,
            "jurisdiction": self.jurisdiction,
            "reporting_authority": self.reporting_authority,
            "field_count": len(self.fields),
            "mandatory_fields": mandatory_fields,
            "conditional_fields": conditional_fields,
            "optional_fields": optional_fields,
            "validation_rule_count": len(self.validation_rules),
            "output_format": self.output_format,
            "tags": self.tags,
        }


# === EMIR REFIT Package ===

def create_emir_package() -> RegulationPackage:
    """Create EMIR REFIT regulation package."""

    fields = [
        # === Counterparty Data ===
        FieldSpec(
            field_id="1",
            field_name="Reporting Timestamp",
            description="Date and time of submission of the report to the trade repository",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            pattern=r"^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$",
            canonical_path="metadata.reporting_timestamp",
            transform="format_datetime_iso",
            xml_element="RptgTmStmp",
        ),
        FieldSpec(
            field_id="2",
            field_name="Report Submitting Entity ID",
            description="LEI of the entity submitting the report",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            min_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptSubmitgNtty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="Reporting Counterparty ID",
            description="LEI of the reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            min_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgCtrPty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="4",
            field_name="Nature of Reporting Counterparty",
            description="Indicate whether the reporting counterparty is a financial or non-financial counterparty",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["F", "N"],
            canonical_path="parties.reporting_counterparty.is_financial_counterparty",
            transform="boolean_to_fn",
            xml_element="NtrOfRptgCtrPty",
        ),
        FieldSpec(
            field_id="5",
            field_name="Corporate Sector of Reporting Counterparty",
            description="Nature of the reporting counterparty's company activities",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Nature of Reporting Counterparty = 'F'",
            enum_values=["A", "C", "F", "I", "L", "O", "R", "U"],
            canonical_path="parties.reporting_counterparty.sector",
            xml_element="CorpSctr",
        ),
        FieldSpec(
            field_id="6",
            field_name="Reporting Counterparty Branch Country",
            description="Country of the branch through which the trade was executed",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.OPTIONAL,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.reporting_counterparty.country_of_domicile",
            xml_element="RptgCtrPtyBrnch",
        ),
        FieldSpec(
            field_id="7",
            field_name="Other Counterparty ID Type",
            description="Type of ID used to identify the other counterparty",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["LEI", "CLC"],
            canonical_path="parties.other_counterparty.lei",
            transform="id_type_from_lei",
            xml_element="OthrCtrPtyIdTp",
        ),
        FieldSpec(
            field_id="8",
            field_name="Other Counterparty ID",
            description="Identifier of the other counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=72,
            canonical_path="parties.other_counterparty.lei",
            xml_element="OthrCtrPty",
            validation_rules=["valid_lei_if_lei_type"],
        ),
        FieldSpec(
            field_id="9",
            field_name="Other Counterparty Country",
            description="Country of domicile of the other counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.other_counterparty.country_of_domicile",
            xml_element="OthrCtrPtyCntry",
        ),

        # === Transaction Data ===
        FieldSpec(
            field_id="10",
            field_name="Action Type",
            description="Type of action taken on the derivative contract",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["NEWT", "MODI", "CORR", "TERM", "EROR", "REVI", "VALU", "POSC", "MARU"],
            canonical_path="transaction_type",
            transform="transaction_type_to_emir_action",
            xml_element="ActnTp",
        ),
        FieldSpec(
            field_id="11",
            field_name="Event Type",
            description="Type of event triggering the report",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["TRAD", "NOVA", "COMP", "ETRM", "CLRG", "EXER", "ALOC", "CREV", "UPDT", "PTNG"],
            canonical_path="event_type",
            xml_element="EvtTp",
        ),
        FieldSpec(
            field_id="12",
            field_name="Event Date",
            description="Date of occurrence of the event",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            pattern=r"^\d{4}-\d{2}-\d{2}$",
            canonical_path="event_timestamp",
            transform="extract_date",
            xml_element="EvtDt",
        ),
        FieldSpec(
            field_id="13",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            pattern=r"^[A-Za-z0-9]{1,52}$",
            canonical_path="uti",
            xml_element="UnqTxIdr",
            validation_rules=["valid_uti"],
        ),
        FieldSpec(
            field_id="14",
            field_name="Prior UTI",
            description="UTI of the predecessor transaction",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Action Type in ['MODI', 'CORR', 'TERM']",
            max_length=52,
            canonical_path="prior_uti",
            xml_element="PrrUnqTxIdr",
        ),
        FieldSpec(
            field_id="15",
            field_name="Report Tracking Number",
            description="Unique number to track report submission",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.OPTIONAL,
            max_length=52,
            canonical_path="report_tracking_number",
            xml_element="RptTrckgNb",
        ),

        # === Product Data ===
        FieldSpec(
            field_id="16",
            field_name="Asset Class",
            description="Asset class of the derivative",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["INTR", "CRDT", "EQUI", "COMM", "CURR"],
            canonical_path="product.asset_class",
            transform="asset_class_to_emir",
            xml_element="AsstClss",
        ),
        FieldSpec(
            field_id="17",
            field_name="Contract Type",
            description="Type of derivative contract",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["CFDS", "FORW", "FRAS", "FUTR", "OPTN", "OTHR", "SPDB", "SWAP", "SWPT"],
            canonical_path="product.product_type",
            transform="product_type_to_emir",
            xml_element="CtrctTp",
        ),
        FieldSpec(
            field_id="18",
            field_name="Product Identification Type",
            description="Type of product identifier used",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            enum_values=["ISIN", "UPI"],
            canonical_path="product.isin",
            transform="id_type_from_isin",
            xml_element="PdctIdTp",
        ),
        FieldSpec(
            field_id="19",
            field_name="Product Identification",
            description="Product identifier (ISIN or UPI)",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=12,
            canonical_path="product.isin",
            xml_element="PdctId",
            validation_rules=["valid_isin_if_isin_type"],
        ),
        FieldSpec(
            field_id="20",
            field_name="CFI Code",
            description="Classification of Financial Instruments code",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.OPTIONAL,
            max_length=6,
            min_length=6,
            pattern=r"^[A-Z]{6}$",
            canonical_path="product.cfi_code",
            xml_element="CFI",
        ),

        # === Economic Terms ===
        FieldSpec(
            field_id="21",
            field_name="Notional Amount",
            description="Reference amount from which contractual payments are determined",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.notional_amount",
            transform="format_decimal_2",
            xml_element="NtnlAmt",
        ),
        FieldSpec(
            field_id="22",
            field_name="Notional Currency",
            description="Currency of the notional amount",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=3,
            pattern=r"^[A-Z]{3}$",
            canonical_path="product.notional_currency",
            xml_element="NtnlCcy",
            validation_rules=["valid_currency"],
        ),
        FieldSpec(
            field_id="23",
            field_name="Price",
            description="Price of the derivative",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.price",
            transform="format_decimal_8",
            xml_element="Pric",
        ),
        FieldSpec(
            field_id="24",
            field_name="Price Currency",
            description="Currency of the price",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            pattern=r"^[A-Z]{3}$",
            canonical_path="product.price_currency",
            xml_element="PricCcy",
        ),
        FieldSpec(
            field_id="25",
            field_name="Effective Date",
            description="Date on which the contract becomes effective",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.effective_date",
            xml_element="FctvDt",
        ),
        FieldSpec(
            field_id="26",
            field_name="Maturity Date",
            description="Original date of expiry of the contract",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.maturity_date",
            xml_element="MtrtyDt",
        ),
        FieldSpec(
            field_id="27",
            field_name="Settlement Date",
            description="Date of settlement",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.settlement_date",
            xml_element="SttlmDt",
        ),

        # === Clearing Data ===
        FieldSpec(
            field_id="28",
            field_name="Cleared",
            description="Whether the contract has been cleared",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["Y", "N", "I"],
            canonical_path="clearing_status",
            transform="clearing_status_to_yni",
            xml_element="Clrd",
        ),
        FieldSpec(
            field_id="29",
            field_name="CCP",
            description="LEI of the CCP that cleared the contract",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Cleared = 'Y'",
            max_length=20,
            canonical_path="ccp_lei",
            xml_element="CCP",
            validation_rules=["valid_lei", "required_if_cleared"],
        ),

        # === Execution Data ===
        FieldSpec(
            field_id="30",
            field_name="Execution Timestamp",
            description="Date and time of execution of the transaction",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="execution.execution_timestamp",
            transform="format_datetime_iso",
            xml_element="ExctnTmStmp",
        ),
        FieldSpec(
            field_id="31",
            field_name="Trading Venue",
            description="MIC of the trading venue",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=4,
            pattern=r"^[A-Z]{4}$",
            canonical_path="execution.trading_venue_mic",
            xml_element="TradgVn",
            validation_rules=["valid_mic"],
        ),

        # === Collateral Data ===
        FieldSpec(
            field_id="32",
            field_name="Collateralisation",
            description="Whether collateral has been exchanged",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["UNCL", "PRC1", "PRC2", "PRCL", "OWC1", "OWC2", "OWP1", "OWP2", "FLCL"],
            canonical_path="collateralization",
            transform="collateralization_to_emir",
            xml_element="Clltrsd",
        ),
        FieldSpec(
            field_id="33",
            field_name="Collateral Portfolio Code",
            description="Code identifying the portfolio of collateral",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=52,
            canonical_path="valuations.0.collateral_portfolio_code",
            xml_element="CllPrtflCd",
        ),
        FieldSpec(
            field_id="34",
            field_name="Initial Margin Posted",
            description="Value of initial margin posted",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.initial_margin_posted",
            transform="format_decimal_2",
            xml_element="InitlMrgnPstd",
        ),
        FieldSpec(
            field_id="35",
            field_name="Initial Margin Posted Currency",
            description="Currency of the initial margin posted",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.initial_margin_posted_currency",
            xml_element="InitlMrgnPstdCcy",
        ),
        FieldSpec(
            field_id="36",
            field_name="Variation Margin Posted",
            description="Value of variation margin posted",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.variation_margin_posted",
            transform="format_decimal_2",
            xml_element="VartnMrgnPstd",
        ),
        FieldSpec(
            field_id="37",
            field_name="Variation Margin Posted Currency",
            description="Currency of the variation margin posted",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.variation_margin_posted_currency",
            xml_element="VartnMrgnPstdCcy",
        ),

        # === Valuation Data ===
        FieldSpec(
            field_id="38",
            field_name="Valuation Amount",
            description="Mark-to-market or mark-to-model valuation",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.valuation_amount",
            transform="format_decimal_2",
            xml_element="ValtnAmt",
        ),
        FieldSpec(
            field_id="39",
            field_name="Valuation Currency",
            description="Currency of the valuation amount",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.valuation_currency",
            xml_element="ValtnCcy",
        ),
        FieldSpec(
            field_id="40",
            field_name="Valuation Timestamp",
            description="Date and time of the valuation",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.valuation_timestamp",
            transform="format_datetime_iso",
            xml_element="ValtnTmStmp",
        ),
    ]

    validation_rules = [
        # ========== FORMAT VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR001",
            name="LEI Format Validation",
            description="LEI must be exactly 20 alphanumeric characters per ISO 17442",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format. Must be 20 alphanumeric characters per ISO 17442.",
            affected_fields=["2", "3", "8", "29"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR002",
            name="LEI Checksum Validation",
            description="LEI must pass MOD 97-10 checksum validation per ISO 17442",
            severity="ERROR",
            rule_type="format",
            expression="lei_checksum_valid(value)",
            error_message="LEI checksum validation failed. Verify LEI is correct.",
            affected_fields=["2", "3", "8", "29"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR003",
            name="UTI Format Validation",
            description="UTI must be 1-52 alphanumeric characters per ISO 23897",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format. Must be 1-52 alphanumeric characters per ISO 23897.",
            affected_fields=["13", "14"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR004",
            name="UTI Prefix LEI Match",
            description="UTI prefix must match a valid LEI (first 20 characters)",
            severity="WARNING",
            rule_type="format",
            expression="len(value) >= 20 and re.match(r'^[A-Z0-9]{20}', value[:20]) is not None",
            error_message="UTI prefix should be a valid LEI per ISO 23897 best practice.",
            affected_fields=["13"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR005",
            name="ISIN Format Validation",
            description="ISIN must be 12 characters per ISO 6166",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', value) is not None",
            error_message="Invalid ISIN format. Must be 2 letter country + 9 alphanumeric + 1 check digit.",
            affected_fields=["19"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR006",
            name="ISIN Checksum Validation",
            description="ISIN must pass Luhn checksum validation",
            severity="ERROR",
            rule_type="format",
            expression="isin_checksum_valid(value)",
            error_message="ISIN checksum validation failed.",
            affected_fields=["19"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR007",
            name="MIC Format Validation",
            description="MIC must be exactly 4 uppercase letters per ISO 10383",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{4}$', value) is not None",
            error_message="Invalid MIC format. Must be 4 uppercase letters.",
            affected_fields=["31"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR008",
            name="Currency Code Validation",
            description="Currency must be valid ISO 4217 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{3}$', value) is not None and value in ISO_4217_CURRENCIES",
            error_message="Invalid currency code. Must be 3-letter ISO 4217 code.",
            affected_fields=["22", "24", "35", "37", "39"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR009",
            name="Country Code Validation",
            description="Country must be valid ISO 3166-1 alpha-2 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}$', value) is not None and value in ISO_3166_COUNTRIES",
            error_message="Invalid country code. Must be ISO 3166-1 alpha-2.",
            affected_fields=["6", "9"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR010",
            name="CFI Code Validation",
            description="CFI code must be 6 uppercase letters per ISO 10962",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{6}$', value) is not None",
            error_message="Invalid CFI code. Must be 6 uppercase letters per ISO 10962.",
            affected_fields=["20"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR011",
            name="DateTime Format Validation",
            description="DateTime must be ISO 8601 with timezone",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$', value) is not None",
            error_message="Invalid datetime format. Must be ISO 8601 with Z timezone.",
            affected_fields=["1", "30", "40"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR012",
            name="Date Format Validation",
            description="Date must be ISO 8601 format YYYY-MM-DD",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}$', value) is not None",
            error_message="Invalid date format. Must be YYYY-MM-DD.",
            affected_fields=["12", "25", "26", "27"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR013",
            name="UPI Format Validation",
            description="UPI must be valid ANNA DSB Unique Product Identifier format",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{12}$', value) is not None",
            error_message="Invalid UPI format. Must match ANNA DSB specification.",
            affected_fields=["19"],
        ),

        # ========== CROSS-FIELD VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR020",
            name="CCP Required if Cleared",
            description="CCP LEI is mandatory when Cleared = 'Y' per ESMA validation rule",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Cleared'] != 'Y' or (record.get('CCP') and len(record.get('CCP', '')) == 20)",
            error_message="CCP LEI is required when the contract is cleared (Field 29).",
            affected_fields=["28", "29"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR021",
            name="Prior UTI Required for Lifecycle Events",
            description="Prior UTI required for MODI, CORR, TERM, EROR, REVI actions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] not in ['MODI', 'CORR', 'TERM', 'EROR', 'REVI'] or record.get('Prior UTI')",
            error_message="Prior UTI is required for modification, correction, termination, and error reports.",
            affected_fields=["10", "14"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR022",
            name="Financial Counterparty Sector Required",
            description="Corporate sector mandatory for financial counterparties (Nature = 'F')",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Nature of Reporting Counterparty'] != 'F' or record.get('Corporate Sector')",
            error_message="Corporate sector is required for financial counterparties.",
            affected_fields=["4", "5"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR023",
            name="NFC Threshold Status Required",
            description="NFC above/below threshold required for non-financial counterparties",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Nature of Reporting Counterparty'] != 'N' or record.get('NFC Threshold Status')",
            error_message="NFC threshold status required for non-financial counterparties.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR024",
            name="Price Currency Required with Price",
            description="Price currency must be provided when price is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Price') or record.get('Price Currency')",
            error_message="Price currency is required when price is specified.",
            affected_fields=["23", "24"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR025",
            name="Valuation Currency Required with Amount",
            description="Valuation currency must be provided when valuation amount is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Valuation Amount') or record.get('Valuation Currency')",
            error_message="Valuation currency is required when valuation amount is specified.",
            affected_fields=["38", "39"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR026",
            name="Margin Posted Currency Required",
            description="Initial margin posted currency required when amount is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Initial Margin Posted') or record.get('Initial Margin Posted Currency')",
            error_message="Initial margin currency required when amount is specified.",
            affected_fields=["34", "35"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR027",
            name="Variation Margin Currency Required",
            description="Variation margin currency required when amount is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Variation Margin Posted') or record.get('Variation Margin Posted Currency')",
            error_message="Variation margin currency required when amount is specified.",
            affected_fields=["36", "37"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR028",
            name="Trading Venue Required for Exchange Traded",
            description="Trading venue MIC required for exchange-traded derivatives",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Execution Venue Type') != 'ETD' or record.get('Trading Venue')",
            error_message="Trading venue MIC is required for exchange-traded derivatives.",
            affected_fields=["31"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR029",
            name="Counterparty Side Consistency",
            description="Reporting and other counterparty cannot be the same entity",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Reporting Counterparty ID') != record.get('Other Counterparty ID')",
            error_message="Reporting counterparty and other counterparty cannot be the same entity.",
            affected_fields=["3", "8"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR030",
            name="Product ID Type Consistency",
            description="Product ID format must match the declared ID type (ISIN or UPI)",
            severity="ERROR",
            rule_type="cross_field",
            expression="(record.get('Product Identification Type') != 'ISIN' or re.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', record.get('Product Identification', ''))) and (record.get('Product Identification Type') != 'UPI' or re.match(r'^[A-Z0-9]{12}$', record.get('Product Identification', '')))",
            error_message="Product identifier format does not match declared type.",
            affected_fields=["18", "19"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR031",
            name="Other Counterparty ID Type Consistency",
            description="If Other CP ID Type is LEI, ID must be valid LEI format",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Other Counterparty ID Type') != 'LEI' or re.match(r'^[A-Z0-9]{20}$', record.get('Other Counterparty ID', ''))",
            error_message="Other counterparty ID must be valid LEI format when ID type is LEI.",
            affected_fields=["7", "8"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR032",
            name="Collateral Portfolio Code Required",
            description="Portfolio code required when collateralization indicates portfolio margining",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Collateralisation') not in ['PRCL', 'PRC1', 'PRC2'] or record.get('Collateral Portfolio Code')",
            error_message="Collateral portfolio code required for portfolio-margined transactions.",
            affected_fields=["32", "33"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR033",
            name="Settlement Date After Execution",
            description="Settlement date must be on or after execution date",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Settlement Date') or record.get('Execution Timestamp')[:10] <= record.get('Settlement Date')",
            error_message="Settlement date cannot be before execution date.",
            affected_fields=["27", "30"],
        ),

        # ========== BUSINESS LOGIC VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR040",
            name="Effective Date Before Maturity",
            description="Effective date must be on or before maturity date",
            severity="ERROR",
            rule_type="business",
            expression="record['Effective Date'] <= record['Maturity Date']",
            error_message="Effective date cannot be after maturity date.",
            affected_fields=["25", "26"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR041",
            name="Positive Notional Amount",
            description="Notional amount must be greater than zero",
            severity="ERROR",
            rule_type="business",
            expression="float(record['Notional Amount']) > 0",
            error_message="Notional amount must be positive.",
            affected_fields=["21"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR042",
            name="Positive Price When Present",
            description="Price must be positive when specified (except for certain derivatives)",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Price') or float(record.get('Price', 0)) >= 0",
            error_message="Price should typically be non-negative.",
            affected_fields=["23"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR043",
            name="Valuation Timestamp Not Future",
            description="Valuation timestamp cannot be in the future",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Valuation Timestamp', '') <= datetime.utcnow().isoformat() + 'Z'",
            error_message="Valuation timestamp cannot be in the future.",
            affected_fields=["40"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR044",
            name="Execution Timestamp Not Future",
            description="Execution timestamp cannot be in the future",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Execution Timestamp', '') <= datetime.utcnow().isoformat() + 'Z'",
            error_message="Execution timestamp cannot be in the future.",
            affected_fields=["30"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR045",
            name="Reporting Timestamp After Execution",
            description="Reporting timestamp must be after or equal to execution timestamp",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Reporting Timestamp', '') >= record.get('Execution Timestamp', '')",
            error_message="Reporting timestamp must be after execution timestamp.",
            affected_fields=["1", "30"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR046",
            name="Event Date Consistency",
            description="Event date should align with action type (NEWT = execution date)",
            severity="WARNING",
            rule_type="business",
            expression="record.get('Action Type') != 'NEWT' or record.get('Event Date') == record.get('Execution Timestamp', '')[:10]",
            error_message="For new trades, event date should match execution date.",
            affected_fields=["10", "12", "30"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR047",
            name="Maturity Date Reasonable Range",
            description="Maturity date should be within 100 years from execution",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Maturity Date') or (int(record.get('Maturity Date', '2020-01-01')[:4]) - int(record.get('Execution Timestamp', '2020-01-01')[:4])) <= 100",
            error_message="Maturity date appears unreasonably far in the future.",
            affected_fields=["26"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR048",
            name="Notional Amount Reasonable Range",
            description="Notional amount should be within reasonable bounds (< 1 quadrillion)",
            severity="WARNING",
            rule_type="business",
            expression="float(record.get('Notional Amount', 0)) < 1e15",
            error_message="Notional amount appears unreasonably large. Please verify.",
            affected_fields=["21"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR049",
            name="Execution Date Not Stale",
            description="Execution date should not be more than T+5 days old for new trades",
            severity="WARNING",
            rule_type="business",
            expression="record.get('Action Type') != 'NEWT' or (datetime.utcnow().date() - datetime.strptime(record.get('Execution Timestamp', '')[:10], '%Y-%m-%d').date()).days <= 5",
            error_message="New trade execution date is more than T+5. Late reporting?",
            affected_fields=["10", "30"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR050",
            name="Asset Class Contract Type Consistency",
            description="Contract type should be consistent with asset class",
            severity="WARNING",
            rule_type="business",
            expression="(record.get('Asset Class') != 'INTR' or record.get('Contract Type') in ['SWAP', 'FRAS', 'FUTR', 'OPTN', 'SWPT', 'OTHR']) and (record.get('Asset Class') != 'CRDT' or record.get('Contract Type') in ['SWAP', 'OPTN', 'CFDS', 'OTHR'])",
            error_message="Contract type may not be appropriate for the asset class.",
            affected_fields=["16", "17"],
        ),

        # ========== ENUM VALUE VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR060",
            name="Valid Action Type",
            description="Action type must be a valid EMIR action code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Action Type') in ['NEWT', 'MODI', 'CORR', 'TERM', 'EROR', 'REVI', 'VALU', 'POSC', 'MARU']",
            error_message="Invalid action type. Must be one of: NEWT, MODI, CORR, TERM, EROR, REVI, VALU, POSC, MARU.",
            affected_fields=["10"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR061",
            name="Valid Event Type",
            description="Event type must be a valid EMIR event code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Event Type') in ['TRAD', 'NOVA', 'COMP', 'ETRM', 'CLRG', 'EXER', 'ALOC', 'CREV', 'UPDT', 'PTNG', 'INCP', 'PTTP']",
            error_message="Invalid event type code.",
            affected_fields=["11"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR062",
            name="Valid Asset Class",
            description="Asset class must be valid EMIR asset class code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Asset Class') in ['INTR', 'CRDT', 'EQUI', 'COMM', 'CURR']",
            error_message="Invalid asset class. Must be one of: INTR, CRDT, EQUI, COMM, CURR.",
            affected_fields=["16"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR063",
            name="Valid Contract Type",
            description="Contract type must be valid derivative type code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Contract Type') in ['CFDS', 'FORW', 'FRAS', 'FUTR', 'OPTN', 'OTHR', 'SPDB', 'SWAP', 'SWPT']",
            error_message="Invalid contract type. Must be one of: CFDS, FORW, FRAS, FUTR, OPTN, OTHR, SPDB, SWAP, SWPT.",
            affected_fields=["17"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR064",
            name="Valid Cleared Status",
            description="Cleared status must be Y, N, or I (intended)",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Cleared') in ['Y', 'N', 'I']",
            error_message="Invalid cleared status. Must be Y (cleared), N (not cleared), or I (intended).",
            affected_fields=["28"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR065",
            name="Valid Collateralisation Type",
            description="Collateralisation must be valid EMIR collateral code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Collateralisation') in ['UNCL', 'PRC1', 'PRC2', 'PRCL', 'OWC1', 'OWC2', 'OWP1', 'OWP2', 'FLCL']",
            error_message="Invalid collateralisation type.",
            affected_fields=["32"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR066",
            name="Valid Nature of Counterparty",
            description="Nature must be F (financial) or N (non-financial)",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Nature of Reporting Counterparty') in ['F', 'N']",
            error_message="Nature of counterparty must be F or N.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR067",
            name="Valid Corporate Sector",
            description="Corporate sector must be valid financial sector code",
            severity="ERROR",
            rule_type="enum",
            expression="not record.get('Corporate Sector') or record.get('Corporate Sector') in ['AIFD', 'CDTI', 'INUN', 'ORPI', 'INVF', 'REIN', 'UCIT', 'ASSU', 'CSDS', 'CCPS']",
            error_message="Invalid corporate sector code.",
            affected_fields=["5"],
        ),

        # ========== PAIRING/RECONCILIATION VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR080",
            name="UTI Uniqueness",
            description="UTI should be unique per counterparty pair for open positions",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Requires database lookup - placeholder
            error_message="Potential duplicate UTI detected for this counterparty pair.",
            affected_fields=["13"],
        ),
        ValidationRuleSpec(
            rule_id="EMIR-VR081",
            name="Counterparty LEI Active Status",
            description="LEIs should be active in GLEIF database",
            severity="WARNING",
            rule_type="referential",
            expression="True",  # Requires external API lookup - placeholder
            error_message="LEI may not be active in GLEIF. Verify counterparty status.",
            affected_fields=["3", "8"],
        ),

        # ========== DELEGATION VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="EMIR-VR090",
            name="Submitting Entity LEI Consistency",
            description="Report submitting entity must be authorized to report for the counterparty",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Requires authorization lookup - placeholder
            error_message="Verify submitting entity is authorized to report for this counterparty.",
            affected_fields=["2", "3"],
        ),
    ]

    return RegulationPackage(
        package_id="emir-refit-2024",
        regulation_code="EMIR",
        regulation_name="European Market Infrastructure Regulation",
        version="REFIT 2024",
        effective_date="2024-04-29",
        description="EMIR REFIT regulation for OTC derivatives reporting in the EU. Implements the revised technical standards for derivative transaction reporting.",
        jurisdiction="EU",
        reporting_authority="ESMA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:iso:std:iso:20022:tech:xsd:auth.030.001.03",
        output_namespace="urn:iso:std:iso:20022:tech:xsd:auth.030.001.03",
        output_root_element="Document",
        tags=["derivatives", "otc", "emir", "refit", "esma"],
    )


# === MiFIR Package ===

def create_mifir_package() -> RegulationPackage:
    """Create MiFIR RTS 25 regulation package."""

    fields = [
        # === Report Header ===
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity ID",
            description="LEI of the investment firm submitting the report",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            min_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.submitting_entity.lei",
            xml_element="RptgNtty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Transmission Date Time",
            description="Date and time of transmission of the report",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="metadata.transmission_timestamp",
            transform="format_datetime_iso",
            xml_element="TxmissnDtTm",
        ),
        FieldSpec(
            field_id="3",
            field_name="Transaction Reference Number",
            description="Unique identification number for the transaction",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="TxRefNb",
        ),

        # === Trading Venue ===
        FieldSpec(
            field_id="4",
            field_name="Trading Venue",
            description="MIC of the venue where transaction was executed",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=4,
            pattern=r"^[A-Z]{4}$",
            canonical_path="execution.trading_venue_mic",
            xml_element="TradgVn",
            validation_rules=["valid_mic"],
        ),
        FieldSpec(
            field_id="5",
            field_name="Trading Date Time",
            description="Date and time when the transaction was executed",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="execution.execution_timestamp",
            transform="format_datetime_iso",
            xml_element="TradgDtTm",
        ),

        # === Buyer Details ===
        FieldSpec(
            field_id="6",
            field_name="Buyer ID Type",
            description="Type of identification for the buyer",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["LEI", "MIC", "INTC", "NATI", "CCPT", "CONCAT"],
            canonical_path="parties.buyer.lei",
            transform="buyer_id_type",
            xml_element="BuyrIdTp",
        ),
        FieldSpec(
            field_id="7",
            field_name="Buyer ID",
            description="Identification code of the buyer",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=50,
            canonical_path="parties.buyer.lei",
            xml_element="BuyrId",
        ),
        FieldSpec(
            field_id="8",
            field_name="Buyer Country",
            description="Country of the buyer branch",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.buyer.country_of_domicile",
            xml_element="BuyrCtry",
        ),
        FieldSpec(
            field_id="9",
            field_name="Buyer Decision Maker ID",
            description="Identification of the person making the investment decision for buyer",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=50,
            canonical_path="parties.buyer.decision_maker_id",
            xml_element="BuyrDcsnMkr",
        ),
        FieldSpec(
            field_id="10",
            field_name="Buyer Decision Maker ID Type",
            description="Type of ID for buyer decision maker",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            enum_values=["NATI", "CCPT", "CONCAT", "NIDN"],
            canonical_path="parties.buyer.decision_maker_id_type",
            xml_element="BuyrDcsnMkrIdTp",
        ),

        # === Seller Details ===
        FieldSpec(
            field_id="11",
            field_name="Seller ID Type",
            description="Type of identification for the seller",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["LEI", "MIC", "INTC", "NATI", "CCPT", "CONCAT"],
            canonical_path="parties.seller.lei",
            transform="seller_id_type",
            xml_element="SellrIdTp",
        ),
        FieldSpec(
            field_id="12",
            field_name="Seller ID",
            description="Identification code of the seller",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=50,
            canonical_path="parties.seller.lei",
            xml_element="SellrId",
        ),
        FieldSpec(
            field_id="13",
            field_name="Seller Country",
            description="Country of the seller branch",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.seller.country_of_domicile",
            xml_element="SellrCtry",
        ),
        FieldSpec(
            field_id="14",
            field_name="Seller Decision Maker ID",
            description="Identification of the person making the investment decision for seller",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=50,
            canonical_path="parties.seller.decision_maker_id",
            xml_element="SellrDcsnMkr",
        ),
        FieldSpec(
            field_id="15",
            field_name="Seller Decision Maker ID Type",
            description="Type of ID for seller decision maker",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            enum_values=["NATI", "CCPT", "CONCAT", "NIDN"],
            canonical_path="parties.seller.decision_maker_id_type",
            xml_element="SellrDcsnMkrIdTp",
        ),

        # === Instrument Identification ===
        FieldSpec(
            field_id="16",
            field_name="Instrument ID Type",
            description="Type of instrument identifier",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["ISIN", "OTHR"],
            canonical_path="product.isin",
            transform="instrument_id_type",
            xml_element="InstrmIdTp",
        ),
        FieldSpec(
            field_id="17",
            field_name="Instrument ID",
            description="Unique identification code for the instrument",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=12,
            canonical_path="product.isin",
            xml_element="InstrmId",
            validation_rules=["valid_isin"],
        ),
        FieldSpec(
            field_id="18",
            field_name="Instrument Full Name",
            description="Full name of the financial instrument",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=350,
            canonical_path="product.instrument_name",
            xml_element="InstrmFullNm",
        ),
        FieldSpec(
            field_id="19",
            field_name="Instrument Classification",
            description="CFI code of the instrument",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=6,
            pattern=r"^[A-Z]{6}$",
            canonical_path="product.cfi_code",
            xml_element="InstrmClssfctn",
        ),

        # === Price Details ===
        FieldSpec(
            field_id="20",
            field_name="Price",
            description="Traded price of the transaction",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.price",
            transform="format_decimal_8",
            xml_element="Pric",
        ),
        FieldSpec(
            field_id="21",
            field_name="Price Currency",
            description="Currency in which the price is expressed",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=3,
            pattern=r"^[A-Z]{3}$",
            canonical_path="product.price_currency",
            xml_element="PricCcy",
            validation_rules=["valid_currency"],
        ),
        FieldSpec(
            field_id="22",
            field_name="Price Notation",
            description="Indicates how the price is expressed",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["MONE", "PERC", "YIEL", "BAPO"],
            default_value="MONE",
            xml_element="PricNtn",
        ),

        # === Quantity Details ===
        FieldSpec(
            field_id="23",
            field_name="Quantity",
            description="Number of units of the financial instrument",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.quantity",
            transform="format_decimal_4",
            xml_element="Qty",
        ),
        FieldSpec(
            field_id="24",
            field_name="Quantity Currency",
            description="Currency in which quantity is expressed (for notional)",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="product.notional_currency",
            xml_element="QtyCcy",
        ),
        FieldSpec(
            field_id="25",
            field_name="Notional Amount",
            description="Nominal amount or notional amount",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.notional_amount",
            transform="format_decimal_2",
            xml_element="NtnlAmt",
        ),
        FieldSpec(
            field_id="26",
            field_name="Notional Currency",
            description="Currency of the notional amount",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="product.notional_currency",
            xml_element="NtnlCcy",
        ),

        # === Dates ===
        FieldSpec(
            field_id="27",
            field_name="Maturity Date",
            description="Maturity date of the financial instrument",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.maturity_date",
            xml_element="MtrtyDt",
        ),

        # === Execution Details ===
        FieldSpec(
            field_id="28",
            field_name="Buy Sell Indicator",
            description="Indicates whether the transaction is a buy or sell",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["BUYI", "SELL"],
            canonical_path="execution.buy_sell_indicator",
            transform="buy_sell_to_mifir",
            xml_element="BuySellInd",
        ),
        FieldSpec(
            field_id="29",
            field_name="Trading Capacity",
            description="Indicates whether the firm dealt as principal or agent",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["DEAL", "MTCH", "AOTC"],
            canonical_path="execution.trading_capacity",
            xml_element="TradgCpcty",
        ),
        FieldSpec(
            field_id="30",
            field_name="Waiver Indicator",
            description="Indicates if transaction benefited from a pre-trade waiver",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=4,
            canonical_path="execution.waiver_indicator",
            xml_element="WvrInd",
        ),
        FieldSpec(
            field_id="31",
            field_name="Short Selling Indicator",
            description="Indicates a short sale transaction",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            enum_values=["SESH", "SSEX", "SELL", "UNDI"],
            canonical_path="execution.short_selling_indicator",
            xml_element="ShrtSellgInd",
        ),
        FieldSpec(
            field_id="32",
            field_name="OTC Post Trade Indicator",
            description="Indicators applicable to OTC post-trade",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=50,
            canonical_path="execution.otc_post_trade_indicator",
            xml_element="OTCPstTradInd",
        ),

        # === Up-front Payment ===
        FieldSpec(
            field_id="33",
            field_name="Up-front Payment",
            description="Amount of any up-front payment",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="execution.up_front_payment",
            transform="format_decimal_2",
            xml_element="UpFrntPmt",
        ),
        FieldSpec(
            field_id="34",
            field_name="Up-front Payment Currency",
            description="Currency of the up-front payment",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="execution.up_front_payment_currency",
            xml_element="UpFrntPmtCcy",
        ),
    ]

    validation_rules = [
        # ========== FORMAT VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR001",
            name="LEI Format Validation",
            description="LEI must be exactly 20 alphanumeric characters per ISO 17442",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format. Must be 20 alphanumeric characters.",
            affected_fields=["1", "7", "12"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR002",
            name="LEI Checksum Validation",
            description="LEI must pass MOD 97-10 checksum validation",
            severity="ERROR",
            rule_type="format",
            expression="lei_checksum_valid(value)",
            error_message="LEI checksum validation failed.",
            affected_fields=["1", "7", "12"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR003",
            name="ISIN Format Validation",
            description="ISIN must be 12 characters per ISO 6166",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', value) is not None",
            error_message="Invalid ISIN format. Must be 2 letter country + 9 alphanumeric + 1 check digit.",
            affected_fields=["17"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR004",
            name="ISIN Checksum Validation",
            description="ISIN must pass Luhn checksum validation",
            severity="ERROR",
            rule_type="format",
            expression="isin_checksum_valid(value)",
            error_message="ISIN checksum validation failed.",
            affected_fields=["17"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR005",
            name="MIC Format Validation",
            description="MIC must be exactly 4 uppercase alphanumeric per ISO 10383",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{4}$', value) is not None",
            error_message="Invalid MIC format. Must be 4 uppercase alphanumeric.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR006",
            name="MIC Valid Code Validation",
            description="MIC must be a valid operating or segment MIC in ISO 10383 registry",
            severity="WARNING",
            rule_type="referential",
            expression="value in VALID_MIC_CODES or value in ['XOFF', 'SINT']",
            error_message="MIC code not found in ISO 10383 registry.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR007",
            name="Currency Code Validation",
            description="Currency must be valid ISO 4217 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{3}$', value) is not None and value in ISO_4217_CURRENCIES",
            error_message="Invalid currency code. Must be 3-letter ISO 4217 code.",
            affected_fields=["21", "24", "26", "34"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR008",
            name="Country Code Validation",
            description="Country must be valid ISO 3166-1 alpha-2 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}$', value) is not None and value in ISO_3166_COUNTRIES",
            error_message="Invalid country code. Must be ISO 3166-1 alpha-2.",
            affected_fields=["8", "13"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR009",
            name="CFI Code Validation",
            description="CFI code must be 6 uppercase letters per ISO 10962",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{6}$', value) is not None",
            error_message="Invalid CFI code. Must be 6 uppercase letters per ISO 10962.",
            affected_fields=["19"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR010",
            name="DateTime Format Validation",
            description="DateTime must be ISO 8601 with microseconds for MiFIR",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{6})?Z$', value) is not None",
            error_message="Invalid datetime format. Must be ISO 8601 with microseconds (YYYY-MM-DDTHH:MM:SS.ffffffZ).",
            affected_fields=["2", "5"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR011",
            name="Date Format Validation",
            description="Date must be ISO 8601 format YYYY-MM-DD",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}$', value) is not None",
            error_message="Invalid date format. Must be YYYY-MM-DD.",
            affected_fields=["27"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR012",
            name="Transaction Reference Number Format",
            description="Transaction reference must be up to 52 characters",
            severity="ERROR",
            rule_type="format",
            expression="len(value) <= 52 and len(value) > 0",
            error_message="Transaction reference must be 1-52 characters.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR013",
            name="National ID Format (CONCAT)",
            description="CONCAT national ID must follow CC#XXXXXXXXXX format",
            severity="ERROR",
            rule_type="format",
            expression="record.get('Buyer ID Type') != 'CONCAT' or re.match(r'^[A-Z]{2}#.+$', value) is not None",
            error_message="CONCAT ID must be in format CC#identifier (country code + hash + ID).",
            affected_fields=["7", "12"],
        ),

        # ========== CROSS-FIELD VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR020",
            name="Buyer Seller Different Entities",
            description="Buyer and seller cannot be identical when ID types match",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Buyer ID') != record.get('Seller ID') or record.get('Buyer ID Type') != record.get('Seller ID Type')",
            error_message="Buyer and seller cannot be the same entity.",
            affected_fields=["6", "7", "11", "12"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR021",
            name="LEI Required for Legal Entities",
            description="LEI must be used for legal entities (not natural persons)",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Buyer ID Type') not in ['LEI'] or re.match(r'^[A-Z0-9]{20}$', record.get('Buyer ID', ''))",
            error_message="When ID type is LEI, identifier must be valid LEI format.",
            affected_fields=["6", "7"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR022",
            name="Decision Maker Country Required",
            description="Country of branch required when decision maker is specified",
            severity="WARNING",
            rule_type="cross_field",
            expression="not record.get('Buyer Decision Maker ID') or record.get('Buyer Country')",
            error_message="Country of branch should be specified when decision maker is provided.",
            affected_fields=["8", "9"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR023",
            name="Price Currency Required with Price",
            description="Price currency must be provided when price is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Price') or record.get('Price Currency')",
            error_message="Price currency is required when price is specified.",
            affected_fields=["20", "21"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR024",
            name="Quantity Currency Required for Monetary Notation",
            description="Quantity currency required when price notation is monetary",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Price Notation') != 'MONE' or record.get('Quantity Currency')",
            error_message="Quantity currency required for monetary notation transactions.",
            affected_fields=["22", "24"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR025",
            name="Notional Amount Currency Consistency",
            description="Notional currency required when notional amount is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Notional Amount') or record.get('Notional Currency')",
            error_message="Notional currency is required when notional amount is specified.",
            affected_fields=["25", "26"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR026",
            name="Up-front Payment Currency Required",
            description="Up-front payment currency required when payment is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Up-front Payment') or record.get('Up-front Payment Currency')",
            error_message="Up-front payment currency required when payment amount specified.",
            affected_fields=["33", "34"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR027",
            name="Trading Venue Transaction ID for On-Venue",
            description="Trading venue transaction ID required for on-venue trades",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Venue') in ['XOFF', 'SINT', 'XXXX'] or record.get('Trading Venue Transaction ID')",
            error_message="Trading venue transaction ID required for on-venue transactions.",
            affected_fields=["3", "4"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR028",
            name="ISIN Required When ID Type is ISIN",
            description="Valid ISIN format required when instrument ID type is ISIN",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Instrument ID Type') != 'ISIN' or re.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', record.get('Instrument ID', ''))",
            error_message="Valid ISIN format required when instrument ID type is ISIN.",
            affected_fields=["16", "17"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR029",
            name="Full Name Required for Non-ISIN",
            description="Instrument full name required when ISIN not available",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Instrument ID Type') == 'ISIN' or record.get('Instrument Full Name')",
            error_message="Instrument full name required when ISIN is not available.",
            affected_fields=["16", "18"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR030",
            name="Short Selling Indicator Consistency",
            description="Short selling indicator only applicable for sell transactions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Buy Sell Indicator') == 'SELL' or not record.get('Short Selling Indicator')",
            error_message="Short selling indicator only valid for sell transactions.",
            affected_fields=["28", "31"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR031",
            name="Waiver Indicator Consistency",
            description="Waiver indicator only applicable for on-venue transactions",
            severity="WARNING",
            rule_type="cross_field",
            expression="record.get('Venue') in ['XOFF', 'SINT'] or not record.get('Waiver Indicator') or record.get('Waiver Indicator')",
            error_message="Waiver indicator typically applies to on-venue transactions.",
            affected_fields=["4", "30"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR032",
            name="Linked Transaction Reference for Amendments",
            description="Linked transaction reference required for CANC and AMND reports",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Report Status') not in ['CANC', 'AMND'] or record.get('Linked Transaction Reference')",
            error_message="Linked transaction reference required for cancellations and amendments.",
            affected_fields=["1"],
        ),

        # ========== BUSINESS LOGIC VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR040",
            name="Positive Price",
            description="Transaction price must be positive (or zero for certain derivatives)",
            severity="ERROR",
            rule_type="business",
            expression="float(record.get('Price', 0)) >= 0",
            error_message="Price must be non-negative.",
            affected_fields=["20"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR041",
            name="Positive Quantity",
            description="Transaction quantity must be greater than zero",
            severity="ERROR",
            rule_type="business",
            expression="float(record.get('Quantity', 0)) > 0",
            error_message="Quantity must be positive.",
            affected_fields=["23"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR042",
            name="Trading Time Before Report Time",
            description="Trading timestamp must be before or equal to transmission timestamp",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Trading Date Time', '') <= record.get('Transmission Date Time', '')",
            error_message="Trading time cannot be after report transmission time.",
            affected_fields=["2", "5"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR043",
            name="Trading Time Not Future",
            description="Trading timestamp cannot be in the future",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Trading Date Time', '') <= datetime.utcnow().isoformat() + 'Z'",
            error_message="Trading timestamp cannot be in the future.",
            affected_fields=["5"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR044",
            name="T+1 Reporting Deadline",
            description="Transaction reports should be submitted by end of T+1",
            severity="WARNING",
            rule_type="business",
            expression="(datetime.utcnow() - datetime.fromisoformat(record.get('Trading Date Time', '').replace('Z', '+00:00').replace('.', '+').split('+')[0])).days <= 1",
            error_message="Report may be late - T+1 reporting deadline applies.",
            affected_fields=["2", "5"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR045",
            name="Maturity Date After Trading Date",
            description="Maturity date must be on or after trading date",
            severity="ERROR",
            rule_type="business",
            expression="not record.get('Maturity Date') or record.get('Trading Date Time', '')[:10] <= record.get('Maturity Date')",
            error_message="Maturity date cannot be before trading date.",
            affected_fields=["5", "27"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR046",
            name="Reasonable Price Range",
            description="Price should be within reasonable bounds for the instrument",
            severity="WARNING",
            rule_type="business",
            expression="float(record.get('Price', 0)) < 1e12",
            error_message="Price appears unusually high. Please verify.",
            affected_fields=["20"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR047",
            name="Reasonable Quantity Range",
            description="Quantity should be within reasonable bounds",
            severity="WARNING",
            rule_type="business",
            expression="float(record.get('Quantity', 0)) < 1e15",
            error_message="Quantity appears unusually high. Please verify.",
            affected_fields=["23"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR048",
            name="Net Amount Consistency",
            description="Net amount should equal approximately price * quantity",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Net Amount') or abs(float(record.get('Net Amount', 0)) - float(record.get('Price', 0)) * float(record.get('Quantity', 0))) / max(float(record.get('Net Amount', 1)), 1) < 0.01",
            error_message="Net amount does not match price * quantity calculation.",
            affected_fields=["20", "23", "39"],
        ),

        # ========== ENUM VALUE VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR060",
            name="Valid Report Status",
            description="Report status must be NEWT, CANC, or AMND",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Report Status') in ['NEWT', 'CANC', 'AMND']",
            error_message="Invalid report status. Must be NEWT, CANC, or AMND.",
            affected_fields=["1"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR061",
            name="Valid Buyer ID Type",
            description="Buyer ID type must be valid MiFIR code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Buyer ID Type') in ['LEI', 'MIC', 'INTC', 'NATI', 'CCPT', 'CONCAT', 'NIDN']",
            error_message="Invalid buyer ID type. Must be LEI, MIC, INTC, NATI, CCPT, CONCAT, or NIDN.",
            affected_fields=["6"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR062",
            name="Valid Seller ID Type",
            description="Seller ID type must be valid MiFIR code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Seller ID Type') in ['LEI', 'MIC', 'INTC', 'NATI', 'CCPT', 'CONCAT', 'NIDN']",
            error_message="Invalid seller ID type. Must be LEI, MIC, INTC, NATI, CCPT, CONCAT, or NIDN.",
            affected_fields=["11"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR063",
            name="Valid Trading Capacity",
            description="Trading capacity must be DEAL, MTCH, or AOTC/APTS",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Trading Capacity') in ['DEAL', 'MTCH', 'AOTC', 'APTS']",
            error_message="Invalid trading capacity. Must be DEAL, MTCH, or AOTC.",
            affected_fields=["29"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR064",
            name="Valid Buy Sell Indicator",
            description="Buy/sell indicator must be BUYI or SELL",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Buy Sell Indicator') in ['BUYI', 'SELL']",
            error_message="Invalid buy/sell indicator. Must be BUYI or SELL.",
            affected_fields=["28"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR065",
            name="Valid Price Notation",
            description="Price notation must be valid MiFIR code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Price Notation') in ['MONE', 'PERC', 'YIEL', 'BAPO']",
            error_message="Invalid price notation. Must be MONE, PERC, YIEL, or BAPO.",
            affected_fields=["22"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR066",
            name="Valid Short Selling Indicator",
            description="Short selling indicator must be valid MiFIR code",
            severity="ERROR",
            rule_type="enum",
            expression="not record.get('Short Selling Indicator') or record.get('Short Selling Indicator') in ['SESH', 'SSEX', 'SELL', 'UNDI']",
            error_message="Invalid short selling indicator.",
            affected_fields=["31"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR067",
            name="Valid Instrument ID Type",
            description="Instrument ID type must be ISIN or OTHR",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Instrument ID Type') in ['ISIN', 'OTHR']",
            error_message="Invalid instrument ID type. Must be ISIN or OTHR.",
            affected_fields=["16"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR068",
            name="Valid Waiver Indicator",
            description="Waiver indicator must be valid MiFIR pre-trade waiver code",
            severity="ERROR",
            rule_type="enum",
            expression="not record.get('Waiver Indicator') or record.get('Waiver Indicator') in ['OILQ', 'NLIQ', 'PRIC', 'SIZE', 'RFPT', 'BENC', 'ILQD', 'RPRI', 'TNCP']",
            error_message="Invalid waiver indicator code.",
            affected_fields=["30"],
        ),

        # ========== NATURAL PERSON VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR080",
            name="Natural Person Name Required",
            description="First name and surname required for natural person identification",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Buyer ID Type') not in ['NATI', 'CCPT', 'CONCAT'] or (record.get('Buyer First Name') and record.get('Buyer Surname'))",
            error_message="First name and surname required for natural person identification.",
            affected_fields=["6", "7"],
        ),
        ValidationRuleSpec(
            rule_id="MIFIR-VR081",
            name="Date of Birth Format",
            description="Date of birth must be valid date in the past",
            severity="ERROR",
            rule_type="format",
            expression="not record.get('Buyer Date of Birth') or (re.match(r'^\\d{4}-\\d{2}-\\d{2}$', record.get('Buyer Date of Birth', '')) and record.get('Buyer Date of Birth', '') < datetime.utcnow().strftime('%Y-%m-%d'))",
            error_message="Date of birth must be valid date in the past.",
            affected_fields=["10"],
        ),

        # ========== ALGO/HFT VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="MIFIR-VR090",
            name="Investment Decision Person Required",
            description="Investment decision maker must be specified",
            severity="WARNING",
            rule_type="cross_field",
            expression="record.get('Trading Capacity') != 'DEAL' or record.get('Investment Decision Person')",
            error_message="Investment decision maker should be specified for principal trading.",
            affected_fields=["29"],
        ),
    ]

    return RegulationPackage(
        package_id="mifir-rts25-2024",
        regulation_code="MIFIR",
        regulation_name="Markets in Financial Instruments Regulation",
        version="RTS 25 2024",
        effective_date="2024-01-01",
        description="MiFIR transaction reporting under RTS 25. Covers all transactions in financial instruments by investment firms in the EU.",
        jurisdiction="EU",
        reporting_authority="ESMA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:iso:std:iso:20022:tech:xsd:auth.016.001.02",
        output_namespace="urn:iso:std:iso:20022:tech:xsd:auth.016.001.02",
        output_root_element="Document",
        tags=["transactions", "mifid", "mifir", "esma", "investment_firms"],
    )


# === SFTR Package ===

def create_sftr_package() -> RegulationPackage:
    """Create SFTR regulation package."""

    fields = [
        # === Counterparty Data ===
        FieldSpec(
            field_id="1",
            field_name="Report Submitting Entity",
            description="LEI of the entity submitting the report",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            min_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptSubmitgNtty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Reporting Counterparty",
            description="LEI of the reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgCtrPty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="Nature of Reporting Counterparty",
            description="Financial or non-financial counterparty",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["F", "N"],
            canonical_path="parties.reporting_counterparty.is_financial_counterparty",
            transform="boolean_to_fn",
            xml_element="NtrOfRptgCtrPty",
        ),
        FieldSpec(
            field_id="4",
            field_name="Sector of Reporting Counterparty",
            description="Sector classification for financial counterparties",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Nature of Reporting Counterparty = 'F'",
            enum_values=["AIFD", "CDTI", "INUN", "ORPI", "INVF", "REIN", "UCIT", "CSDS", "CCPS"],
            canonical_path="parties.reporting_counterparty.sector",
            xml_element="SctrOfRptgCtrPty",
        ),
        FieldSpec(
            field_id="5",
            field_name="Reporting Counterparty Branch",
            description="Country of the branch of the reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.reporting_counterparty.country_of_domicile",
            xml_element="RptgCtrPtyBrnch",
        ),
        FieldSpec(
            field_id="6",
            field_name="Other Counterparty Type",
            description="Type of identification for other counterparty",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["L", "E", "C", "I", "O"],
            canonical_path="parties.other_counterparty.lei",
            transform="other_cp_type",
            xml_element="OthrCtrPtyTp",
        ),
        FieldSpec(
            field_id="7",
            field_name="Other Counterparty",
            description="Identifier of the other counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=72,
            canonical_path="parties.other_counterparty.lei",
            xml_element="OthrCtrPty",
        ),
        FieldSpec(
            field_id="8",
            field_name="Other Counterparty Country",
            description="Country of the other counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=2,
            pattern=r"^[A-Z]{2}$",
            canonical_path="parties.other_counterparty.country_of_domicile",
            xml_element="OthrCtrPtyCntry",
        ),
        FieldSpec(
            field_id="9",
            field_name="Beneficiary",
            description="LEI of the beneficiary of the rights and obligations",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=20,
            canonical_path="parties.beneficiary.lei",
            xml_element="Bnfcry",
        ),
        FieldSpec(
            field_id="10",
            field_name="Tri-party Agent",
            description="LEI of the tri-party agent",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=20,
            canonical_path="parties.agent.lei",
            xml_element="TrptyAgt",
        ),
        FieldSpec(
            field_id="11",
            field_name="Broker",
            description="LEI of the broker",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=20,
            canonical_path="parties.broker.lei",
            xml_element="Brkr",
        ),

        # === Loan and Collateral Data ===
        FieldSpec(
            field_id="12",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            pattern=r"^[A-Za-z0-9]{1,52}$",
            canonical_path="uti",
            xml_element="UnqTxIdr",
            validation_rules=["valid_uti"],
        ),
        FieldSpec(
            field_id="13",
            field_name="Report Tracking Number",
            description="Unique report tracking number",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.OPTIONAL,
            max_length=52,
            canonical_path="report_tracking_number",
            xml_element="RptTrckgNb",
        ),
        FieldSpec(
            field_id="14",
            field_name="Event Date",
            description="Date of the reportable event",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="event_timestamp",
            transform="extract_date",
            xml_element="EvtDt",
        ),
        FieldSpec(
            field_id="15",
            field_name="Type of SFT",
            description="Type of securities financing transaction",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["REPO", "BSBC", "SLEB", "MGLD"],
            canonical_path="product.product_type",
            transform="product_type_to_sftr",
            xml_element="TpOfSFT",
        ),
        FieldSpec(
            field_id="16",
            field_name="Cleared",
            description="Whether the SFT is cleared",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["Y", "N"],
            canonical_path="clearing_status",
            transform="clearing_status_to_yn",
            xml_element="Clrd",
        ),
        FieldSpec(
            field_id="17",
            field_name="CCP",
            description="LEI of the CCP if cleared",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Cleared = 'Y'",
            max_length=20,
            canonical_path="ccp_lei",
            xml_element="CCP",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="18",
            field_name="Trading Venue",
            description="MIC of the trading venue",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=4,
            canonical_path="execution.trading_venue_mic",
            xml_element="TradgVn",
            validation_rules=["valid_mic"],
        ),

        # === Action Type ===
        FieldSpec(
            field_id="19",
            field_name="Action Type",
            description="Type of action on the SFT",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["NEWT", "MODI", "VALU", "COLU", "EROR", "CORR", "ETRM", "POSC"],
            canonical_path="transaction_type",
            transform="transaction_type_to_sftr",
            xml_element="ActnTp",
        ),

        # === Principal Amount ===
        FieldSpec(
            field_id="20",
            field_name="Principal Amount",
            description="Value of the loan or securities lent",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.notional_amount",
            transform="format_decimal_2",
            xml_element="PrncplAmt",
        ),
        FieldSpec(
            field_id="21",
            field_name="Principal Amount Currency",
            description="Currency of the principal amount",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=3,
            pattern=r"^[A-Z]{3}$",
            canonical_path="product.notional_currency",
            xml_element="PrncplAmtCcy",
            validation_rules=["valid_currency"],
        ),

        # === Dates ===
        FieldSpec(
            field_id="22",
            field_name="Value Date",
            description="Start date of the SFT",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.effective_date",
            xml_element="ValDt",
        ),
        FieldSpec(
            field_id="23",
            field_name="Maturity Date",
            description="End date of the SFT",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.maturity_date",
            xml_element="MtrtyDt",
        ),
        FieldSpec(
            field_id="24",
            field_name="Termination Date",
            description="Date of early termination",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="product.settlement_date",
            xml_element="TermntnDt",
        ),

        # === Collateral Data ===
        FieldSpec(
            field_id="25",
            field_name="Collateralisation",
            description="Method of collateralisation",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["SIUR", "SITR", "TITL", "PSEG", "PSPN", "PSSH", "IGAS", "OOXX", "TTCA"],
            canonical_path="collateralization",
            transform="collateralization_to_sftr",
            xml_element="Clltn",
        ),
        FieldSpec(
            field_id="26",
            field_name="Collateral Portfolio Indicator",
            description="Whether collateral is posted on a portfolio basis",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["Y", "N"],
            default_value="N",
            xml_element="CllPrtflInd",
        ),
        FieldSpec(
            field_id="27",
            field_name="Collateral Portfolio Code",
            description="Code identifying the collateral portfolio",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            condition="Collateral Portfolio Indicator = 'Y'",
            max_length=52,
            canonical_path="valuations.0.collateral_portfolio_code",
            xml_element="CllPrtflCd",
        ),

        # === Margin Data ===
        FieldSpec(
            field_id="28",
            field_name="Initial Margin Posted",
            description="Value of initial margin posted",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.initial_margin_posted",
            transform="format_decimal_2",
            xml_element="InitlMrgnPstd",
        ),
        FieldSpec(
            field_id="29",
            field_name="Initial Margin Posted Currency",
            description="Currency of initial margin posted",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.initial_margin_posted_currency",
            xml_element="InitlMrgnPstdCcy",
        ),
        FieldSpec(
            field_id="30",
            field_name="Initial Margin Received",
            description="Value of initial margin received",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.initial_margin_received",
            transform="format_decimal_2",
            xml_element="InitlMrgnRcvd",
        ),
        FieldSpec(
            field_id="31",
            field_name="Initial Margin Received Currency",
            description="Currency of initial margin received",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.initial_margin_received_currency",
            xml_element="InitlMrgnRcvdCcy",
        ),
        FieldSpec(
            field_id="32",
            field_name="Variation Margin Posted",
            description="Value of variation margin posted",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.variation_margin_posted",
            transform="format_decimal_2",
            xml_element="VartnMrgnPstd",
        ),
        FieldSpec(
            field_id="33",
            field_name="Variation Margin Posted Currency",
            description="Currency of variation margin posted",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.variation_margin_posted_currency",
            xml_element="VartnMrgnPstdCcy",
        ),
        FieldSpec(
            field_id="34",
            field_name="Variation Margin Received",
            description="Value of variation margin received",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.CONDITIONAL,
            canonical_path="valuations.0.variation_margin_received",
            transform="format_decimal_2",
            xml_element="VartnMrgnRcvd",
        ),
        FieldSpec(
            field_id="35",
            field_name="Variation Margin Received Currency",
            description="Currency of variation margin received",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.CONDITIONAL,
            max_length=3,
            canonical_path="valuations.0.variation_margin_received_currency",
            xml_element="VartnMrgnRcvdCcy",
        ),

        # === Execution Timestamp ===
        FieldSpec(
            field_id="36",
            field_name="Execution Timestamp",
            description="Date and time of execution",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="execution.execution_timestamp",
            transform="format_datetime_iso",
            xml_element="ExctnTmStmp",
        ),
        FieldSpec(
            field_id="37",
            field_name="Reporting Timestamp",
            description="Date and time of report submission",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="metadata.reporting_timestamp",
            transform="format_datetime_iso",
            xml_element="RptgTmStmp",
        ),
    ]

    validation_rules = [
        # ========== FORMAT VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR001",
            name="LEI Format Validation",
            description="LEI must be exactly 20 alphanumeric characters per ISO 17442",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format. Must be 20 alphanumeric characters.",
            affected_fields=["1", "2", "7", "9", "10", "11", "17"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR002",
            name="LEI Checksum Validation",
            description="LEI must pass MOD 97-10 checksum validation",
            severity="ERROR",
            rule_type="format",
            expression="lei_checksum_valid(value)",
            error_message="LEI checksum validation failed.",
            affected_fields=["1", "2", "7", "9", "10", "11", "17"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR003",
            name="UTI Format Validation",
            description="UTI must be 1-52 alphanumeric characters per ISO 23897",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format. Must be 1-52 alphanumeric characters.",
            affected_fields=["12"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR004",
            name="UTI Prefix LEI Match",
            description="UTI prefix should be a valid LEI (first 20 characters)",
            severity="WARNING",
            rule_type="format",
            expression="len(value) >= 20 and re.match(r'^[A-Z0-9]{20}', value[:20]) is not None",
            error_message="UTI prefix should be a valid LEI per best practice.",
            affected_fields=["12"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR005",
            name="ISIN Format Validation",
            description="ISIN must be 12 characters per ISO 6166",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}[A-Z0-9]{9}[0-9]$', value) is not None",
            error_message="Invalid ISIN format. Must be 2 letter country + 9 alphanumeric + 1 check digit.",
            affected_fields=["security_isin", "collateral_isin"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR006",
            name="ISIN Checksum Validation",
            description="ISIN must pass Luhn checksum validation",
            severity="ERROR",
            rule_type="format",
            expression="isin_checksum_valid(value)",
            error_message="ISIN checksum validation failed.",
            affected_fields=["security_isin", "collateral_isin"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR007",
            name="MIC Format Validation",
            description="MIC must be exactly 4 uppercase alphanumeric per ISO 10383",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{4}$', value) is not None",
            error_message="Invalid MIC format. Must be 4 uppercase alphanumeric.",
            affected_fields=["18"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR008",
            name="Currency Code Validation",
            description="Currency must be valid ISO 4217 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{3}$', value) is not None and value in ISO_4217_CURRENCIES",
            error_message="Invalid currency code. Must be 3-letter ISO 4217 code.",
            affected_fields=["21", "29", "31", "33", "35"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR009",
            name="Country Code Validation",
            description="Country must be valid ISO 3166-1 alpha-2 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{2}$', value) is not None and value in ISO_3166_COUNTRIES",
            error_message="Invalid country code. Must be ISO 3166-1 alpha-2.",
            affected_fields=["5", "8"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR010",
            name="CFI Code Validation",
            description="CFI code must be 6 uppercase letters per ISO 10962",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{6}$', value) is not None",
            error_message="Invalid CFI code. Must be 6 uppercase letters per ISO 10962.",
            affected_fields=["security_cfi"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR011",
            name="DateTime Format Validation",
            description="DateTime must be ISO 8601 with timezone",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$', value) is not None",
            error_message="Invalid datetime format. Must be ISO 8601 with Z timezone.",
            affected_fields=["36", "37"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR012",
            name="Date Format Validation",
            description="Date must be ISO 8601 format YYYY-MM-DD",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^\\d{4}-\\d{2}-\\d{2}$', value) is not None",
            error_message="Invalid date format. Must be YYYY-MM-DD.",
            affected_fields=["14", "22", "23", "24"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR013",
            name="Rate Format Validation",
            description="Rate/spread values must be valid decimal numbers",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^-?\\d+(\\.\\d+)?$', str(value)) is not None",
            error_message="Invalid rate format. Must be a valid decimal number.",
            affected_fields=["repo_rate", "lending_fee", "spread"],
        ),

        # ========== CROSS-FIELD VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR020",
            name="CCP Required if Cleared",
            description="CCP LEI mandatory when Cleared = 'Y'",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Cleared'] != 'Y' or (record.get('CCP') and len(record.get('CCP', '')) == 20)",
            error_message="CCP LEI is required when the SFT is cleared.",
            affected_fields=["16", "17"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR021",
            name="Collateral Portfolio Code Required",
            description="Portfolio code required when Portfolio Indicator = 'Y'",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Collateral Portfolio Indicator'] != 'Y' or record.get('Collateral Portfolio Code')",
            error_message="Collateral portfolio code required when portfolio indicator is Y.",
            affected_fields=["26", "27"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR022",
            name="Financial Counterparty Sector Required",
            description="Sector mandatory for financial counterparties (Nature = 'F')",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Nature of Reporting Counterparty'] != 'F' or record.get('Sector of Reporting Counterparty')",
            error_message="Sector is required for financial counterparties.",
            affected_fields=["3", "4"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR023",
            name="Initial Margin Posted Currency Required",
            description="Currency required when initial margin posted is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Initial Margin Posted') or record.get('Initial Margin Posted Currency')",
            error_message="Currency required when initial margin posted is specified.",
            affected_fields=["28", "29"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR024",
            name="Initial Margin Received Currency Required",
            description="Currency required when initial margin received is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Initial Margin Received') or record.get('Initial Margin Received Currency')",
            error_message="Currency required when initial margin received is specified.",
            affected_fields=["30", "31"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR025",
            name="Variation Margin Posted Currency Required",
            description="Currency required when variation margin posted is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Variation Margin Posted') or record.get('Variation Margin Posted Currency')",
            error_message="Currency required when variation margin posted is specified.",
            affected_fields=["32", "33"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR026",
            name="Variation Margin Received Currency Required",
            description="Currency required when variation margin received is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Variation Margin Received') or record.get('Variation Margin Received Currency')",
            error_message="Currency required when variation margin received is specified.",
            affected_fields=["34", "35"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR027",
            name="Principal Amount Currency Required",
            description="Currency required when principal amount is specified",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Principal Amount') or record.get('Principal Amount Currency')",
            error_message="Currency required when principal amount is specified.",
            affected_fields=["20", "21"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR028",
            name="Beneficiary Required for Agent Lending",
            description="Beneficiary LEI required when reporting as lending agent",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Type of SFT') != 'SLEB' or not record.get('Agent Lender Indicator') or record.get('Beneficiary')",
            error_message="Beneficiary LEI required for agent lending transactions.",
            affected_fields=["9"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR029",
            name="Tri-party Agent Required for Tri-party Repo",
            description="Tri-party agent LEI required when tri-party indicator is true",
            severity="ERROR",
            rule_type="cross_field",
            expression="not record.get('Tri-party Indicator') or record.get('Tri-party Agent')",
            error_message="Tri-party agent LEI required when tri-party indicator is set.",
            affected_fields=["10"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR030",
            name="Other Counterparty LEI for LEI Type",
            description="If Other CP Type is 'L' (LEI), ID must be valid LEI format",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Other Counterparty Type') != 'L' or re.match(r'^[A-Z0-9]{20}$', record.get('Other Counterparty', ''))",
            error_message="Other counterparty ID must be valid LEI format when type is L.",
            affected_fields=["6", "7"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR031",
            name="Counterparty Side Consistency",
            description="Reporting and other counterparty cannot be the same entity",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Reporting Counterparty') != record.get('Other Counterparty')",
            error_message="Reporting counterparty and other counterparty cannot be the same entity.",
            affected_fields=["2", "7"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR032",
            name="Prior UTI Required for Lifecycle Events",
            description="Prior UTI required for MODI, CORR, ETRM actions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] not in ['MODI', 'CORR', 'ETRM'] or record.get('Prior UTI')",
            error_message="Prior UTI is required for modification, correction, and early termination reports.",
            affected_fields=["19"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR033",
            name="Termination Date Required for ETRM",
            description="Termination date required for early termination reports",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] != 'ETRM' or record.get('Termination Date')",
            error_message="Termination date required for early termination reports.",
            affected_fields=["19", "24"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR034",
            name="Collateral Data Required for Collateral Update",
            description="Collateral data required for COLU action type",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] != 'COLU' or (record.get('Collateralisation') and record.get('Collateral Portfolio Indicator'))",
            error_message="Collateral data required for collateral update reports.",
            affected_fields=["19", "25", "26"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR035",
            name="Valuation Data Required for VALU",
            description="Valuation data required for valuation update reports",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] != 'VALU' or record.get('Mark-to-Market Value')",
            error_message="Mark-to-market value required for valuation update reports.",
            affected_fields=["19"],
        ),

        # ========== BUSINESS LOGIC VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR040",
            name="Positive Principal Amount",
            description="Principal amount must be positive",
            severity="ERROR",
            rule_type="business",
            expression="float(record['Principal Amount']) > 0",
            error_message="Principal amount must be positive.",
            affected_fields=["20"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR041",
            name="Value Date Before Maturity",
            description="Value date must be on or before maturity date",
            severity="ERROR",
            rule_type="business",
            expression="not record.get('Maturity Date') or record['Value Date'] <= record['Maturity Date']",
            error_message="Value date cannot be after maturity date.",
            affected_fields=["22", "23"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR042",
            name="Termination Date After Value Date",
            description="Termination date must be on or after value date",
            severity="ERROR",
            rule_type="business",
            expression="not record.get('Termination Date') or record.get('Termination Date') >= record['Value Date']",
            error_message="Termination date cannot be before value date.",
            affected_fields=["22", "24"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR043",
            name="Execution Timestamp Not Future",
            description="Execution timestamp cannot be in the future",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Execution Timestamp', '') <= datetime.utcnow().isoformat() + 'Z'",
            error_message="Execution timestamp cannot be in the future.",
            affected_fields=["36"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR044",
            name="Reporting Timestamp After Execution",
            description="Reporting timestamp must be after or equal to execution timestamp",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Reporting Timestamp', '') >= record.get('Execution Timestamp', '')",
            error_message="Reporting timestamp must be after execution timestamp.",
            affected_fields=["36", "37"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR045",
            name="Event Date Reasonable",
            description="Event date should not be more than 1 year in the past for new trades",
            severity="WARNING",
            rule_type="business",
            expression="record.get('Action Type') != 'NEWT' or (datetime.utcnow().date() - datetime.strptime(record.get('Event Date', ''), '%Y-%m-%d').date()).days <= 365",
            error_message="Event date appears very old for a new SFT report.",
            affected_fields=["14"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR046",
            name="T+1 Reporting Deadline",
            description="Transaction reports should be submitted by end of T+1",
            severity="WARNING",
            rule_type="business",
            expression="record.get('Action Type') not in ['NEWT', 'MODI'] or (datetime.utcnow().date() - datetime.strptime(record.get('Event Date', ''), '%Y-%m-%d').date()).days <= 1",
            error_message="Report may be late - T+1 reporting deadline applies.",
            affected_fields=["14"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR047",
            name="Maturity Date Reasonable Range",
            description="Maturity date should be within 50 years from value date",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Maturity Date') or (int(record.get('Maturity Date', '2020-01-01')[:4]) - int(record.get('Value Date', '2020-01-01')[:4])) <= 50",
            error_message="Maturity date appears unreasonably far in the future.",
            affected_fields=["23"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR048",
            name="Principal Amount Reasonable Range",
            description="Principal amount should be within reasonable bounds",
            severity="WARNING",
            rule_type="business",
            expression="float(record.get('Principal Amount', 0)) < 1e15",
            error_message="Principal amount appears unreasonably large. Please verify.",
            affected_fields=["20"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR049",
            name="Haircut Percentage Range",
            description="Haircut percentage should be between 0 and 100",
            severity="ERROR",
            rule_type="business",
            expression="not record.get('Haircut') or (0 <= float(record.get('Haircut', 0)) <= 100)",
            error_message="Haircut percentage must be between 0 and 100.",
            affected_fields=["haircut"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR050",
            name="Rebate Rate Reasonable",
            description="Rebate rate should be within reasonable bounds",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Rebate Rate') or (-50 <= float(record.get('Rebate Rate', 0)) <= 50)",
            error_message="Rebate rate appears outside normal range.",
            affected_fields=["rebate_rate"],
        ),

        # ========== ENUM VALUE VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR060",
            name="Valid SFT Type",
            description="Type of SFT must be valid SFTR code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Type of SFT') in ['REPO', 'BSBC', 'SLEB', 'MGLD']",
            error_message="Invalid SFT type. Must be REPO, BSBC, SLEB, or MGLD.",
            affected_fields=["15"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR061",
            name="Valid Action Type",
            description="Action type must be valid SFTR action code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Action Type') in ['NEWT', 'MODI', 'VALU', 'COLU', 'EROR', 'CORR', 'ETRM', 'POSC']",
            error_message="Invalid action type. Must be NEWT, MODI, VALU, COLU, EROR, CORR, ETRM, or POSC.",
            affected_fields=["19"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR062",
            name="Valid Cleared Status",
            description="Cleared status must be Y or N",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Cleared') in ['Y', 'N']",
            error_message="Invalid cleared status. Must be Y or N.",
            affected_fields=["16"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR063",
            name="Valid Collateralisation Type",
            description="Collateralisation must be valid SFTR collateral code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Collateralisation') in ['SIUR', 'SITR', 'TITL', 'PSEG', 'PSPN', 'PSSH', 'IGAS', 'OOXX', 'TTCA']",
            error_message="Invalid collateralisation type.",
            affected_fields=["25"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR064",
            name="Valid Nature of Counterparty",
            description="Nature must be F (financial) or N (non-financial)",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Nature of Reporting Counterparty') in ['F', 'N']",
            error_message="Nature of counterparty must be F or N.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR065",
            name="Valid Sector Code",
            description="Sector must be valid SFTR financial sector code",
            severity="ERROR",
            rule_type="enum",
            expression="not record.get('Sector of Reporting Counterparty') or record.get('Sector of Reporting Counterparty') in ['AIFD', 'CDTI', 'INUN', 'ORPI', 'INVF', 'REIN', 'UCIT', 'CSDS', 'CCPS']",
            error_message="Invalid sector code.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR066",
            name="Valid Other Counterparty Type",
            description="Other counterparty type must be valid code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Other Counterparty Type') in ['L', 'E', 'C', 'I', 'O']",
            error_message="Invalid other counterparty type. Must be L, E, C, I, or O.",
            affected_fields=["6"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR067",
            name="Valid Collateral Portfolio Indicator",
            description="Collateral portfolio indicator must be Y or N",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Collateral Portfolio Indicator') in ['Y', 'N']",
            error_message="Collateral portfolio indicator must be Y or N.",
            affected_fields=["26"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR068",
            name="Valid Floating Rate Reference",
            description="Floating rate reference must be valid benchmark code",
            severity="ERROR",
            rule_type="enum",
            expression="not record.get('Floating Rate Reference') or record.get('Floating Rate Reference') in ['ESTR', 'SONIA', 'SOFR', 'EURI', 'LIBO', 'TIBO', 'STBO', 'BBSW', 'TONAR', 'CDOR']",
            error_message="Invalid floating rate reference code.",
            affected_fields=["floating_rate_reference"],
        ),

        # ========== REPO-SPECIFIC VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR080",
            name="Repo Rate Required for REPO",
            description="Repo rate required for repurchase agreement transactions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Type of SFT') != 'REPO' or record.get('Repo Rate') is not None",
            error_message="Repo rate is required for repurchase agreement transactions.",
            affected_fields=["15", "repo_rate"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR081",
            name="Repo Rate Reasonable Range",
            description="Repo rate should be within reasonable bounds",
            severity="WARNING",
            rule_type="business",
            expression="not record.get('Repo Rate') or (-10 <= float(record.get('Repo Rate', 0)) <= 50)",
            error_message="Repo rate appears outside normal range (-10% to 50%).",
            affected_fields=["repo_rate"],
        ),

        # ========== SECURITIES LENDING VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR090",
            name="Lending Fee Required for SLEB",
            description="Lending fee required for securities lending transactions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Type of SFT') != 'SLEB' or record.get('Lending Fee') is not None or record.get('Rebate Rate') is not None",
            error_message="Lending fee or rebate rate required for securities lending.",
            affected_fields=["15"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR091",
            name="Security ISIN Required",
            description="Security ISIN required for securities lending transactions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Type of SFT') != 'SLEB' or record.get('Security ISIN')",
            error_message="Security ISIN required for securities lending transactions.",
            affected_fields=["15"],
        ),

        # ========== PAIRING/RECONCILIATION VALIDATIONS ==========
        ValidationRuleSpec(
            rule_id="SFTR-VR095",
            name="UTI Uniqueness",
            description="UTI should be unique per counterparty pair",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Requires database lookup - placeholder
            error_message="Potential duplicate UTI detected.",
            affected_fields=["12"],
        ),
        ValidationRuleSpec(
            rule_id="SFTR-VR096",
            name="Counterparty LEI Active",
            description="LEIs should be active in GLEIF database",
            severity="WARNING",
            rule_type="referential",
            expression="True",  # Requires external API - placeholder
            error_message="LEI may not be active. Verify counterparty status.",
            affected_fields=["2", "7"],
        ),
    ]

    return RegulationPackage(
        package_id="sftr-2024",
        regulation_code="SFTR",
        regulation_name="Securities Financing Transactions Regulation",
        version="2.0 2024",
        effective_date="2024-01-01",
        description="SFTR reporting for securities financing transactions including repos, securities lending, buy-sell back, and margin lending in the EU.",
        jurisdiction="EU",
        reporting_authority="ESMA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:iso:std:iso:20022:tech:xsd:auth.052.001.02",
        output_namespace="urn:iso:std:iso:20022:tech:xsd:auth.052.001.02",
        output_root_element="Document",
        tags=["sft", "repo", "securities_lending", "sftr", "esma"],
    )


# === CFTC Package (US) ===

def create_cftc_package() -> RegulationPackage:
    """Create CFTC Swap Data Reporting package."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity LEI",
            description="LEI of the reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgCtrPtyId",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Non-Reporting Counterparty LEI",
            description="LEI of the non-reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.other_counterparty.lei",
            xml_element="NonRptgCtrPtyId",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="USI",
            description="Unique Swap Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=42,
            pattern=r"^[A-Za-z0-9]{1,42}$",
            canonical_path="uti",
            xml_element="USI",
            validation_rules=["valid_usi"],
        ),
        FieldSpec(
            field_id="4",
            field_name="UPI",
            description="Unique Product Identifier (ANNA DSB)",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=12,
            pattern=r"^[A-Z0-9]{12}$",
            canonical_path="product.upi",
            xml_element="UPI",
            validation_rules=["valid_upi"],
        ),
        FieldSpec(
            field_id="5",
            field_name="Action Type",
            description="Type of action being reported",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["NEWT", "MODI", "CORR", "TERM", "EROR", "REVI", "VALU", "MARU", "PRTO", "POSC"],
            canonical_path="transaction_type",
            xml_element="ActnTp",
        ),
        FieldSpec(
            field_id="6",
            field_name="Execution Timestamp",
            description="Date and time of execution",
            data_type=FieldDataType.DATETIME,
            requirement=FieldRequirement.MANDATORY,
            pattern=r"^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z$",
            canonical_path="execution.execution_timestamp",
            xml_element="ExctnTmStmp",
        ),
        FieldSpec(
            field_id="7",
            field_name="Effective Date",
            description="Effective date of the swap",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.effective_date",
            xml_element="FctvDt",
        ),
        FieldSpec(
            field_id="8",
            field_name="Maturity Date",
            description="Maturity date of the swap",
            data_type=FieldDataType.DATE,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.maturity_date",
            xml_element="MtrtyDt",
        ),
        FieldSpec(
            field_id="9",
            field_name="Notional Amount",
            description="Notional amount",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.notional_amount",
            xml_element="NtnlAmt",
        ),
        FieldSpec(
            field_id="10",
            field_name="Notional Currency",
            description="Currency of notional amount",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=3,
            pattern=r"^[A-Z]{3}$",
            canonical_path="product.notional_currency",
            xml_element="NtnlCcy",
            validation_rules=["valid_currency"],
        ),
        FieldSpec(
            field_id="11",
            field_name="Asset Class",
            description="Asset class of the swap",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["CR", "CO", "EQ", "FX", "IR"],
            canonical_path="product.asset_class",
            xml_element="AsstClss",
        ),
        FieldSpec(
            field_id="12",
            field_name="Cleared",
            description="Whether the swap is cleared",
            data_type=FieldDataType.BOOLEAN,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="clearing_status",
            xml_element="Clrd",
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="CFTC-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR002",
            name="LEI Checksum Validation",
            description="LEI must pass MOD 97-10 checksum",
            severity="ERROR",
            rule_type="format",
            expression="lei_checksum_valid(value)",
            error_message="LEI checksum validation failed.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR003",
            name="USI Format Validation",
            description="USI must be 1-42 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,42}$', value) is not None",
            error_message="Invalid USI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR004",
            name="UPI Format Validation",
            description="UPI must be exactly 12 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{12}$', value) is not None",
            error_message="Invalid UPI format. Must be 12 alphanumeric characters.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR005",
            name="UPI Required",
            description="UPI is mandatory for all swaps as of January 2024",
            severity="ERROR",
            rule_type="required",
            expression="record.get('UPI') and len(record.get('UPI', '')) == 12",
            error_message="UPI is required for CFTC reporting.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR006",
            name="Currency Code Validation",
            description="Currency must be valid ISO 4217 code",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{3}$', value) is not None",
            error_message="Invalid currency code.",
            affected_fields=["10"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR007",
            name="Positive Notional",
            description="Notional amount must be positive",
            severity="ERROR",
            rule_type="business",
            expression="float(record['Notional Amount']) > 0",
            error_message="Notional amount must be positive.",
            affected_fields=["9"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR008",
            name="Effective Before Maturity",
            description="Effective date must be before maturity date",
            severity="ERROR",
            rule_type="business",
            expression="record['Effective Date'] <= record['Maturity Date']",
            error_message="Effective date cannot be after maturity date.",
            affected_fields=["7", "8"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR009",
            name="CCP Required if Cleared",
            description="CCP LEI required when swap is cleared",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Cleared') != True or record.get('CCP LEI')",
            error_message="CCP LEI required for cleared swaps.",
            affected_fields=["12"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR010",
            name="Valid Action Type",
            description="Action type must be valid CFTC action code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Action Type') in ['NEWT', 'MODI', 'CORR', 'TERM', 'EROR', 'REVI', 'VALU', 'MARU', 'PRTO', 'POSC']",
            error_message="Invalid action type.",
            affected_fields=["5"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR011",
            name="Valid Asset Class",
            description="Asset class must be valid CFTC code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Asset Class') in ['CR', 'CO', 'EQ', 'FX', 'IR']",
            error_message="Invalid asset class. Must be CR, CO, EQ, FX, or IR.",
            affected_fields=["11"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR012",
            name="Execution Not Future",
            description="Execution timestamp cannot be in the future",
            severity="ERROR",
            rule_type="business",
            expression="record.get('Execution Timestamp', '') <= datetime.utcnow().isoformat() + 'Z'",
            error_message="Execution timestamp cannot be in the future.",
            affected_fields=["6"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR013",
            name="T+1 Reporting Deadline",
            description="Swap reports should be submitted by T+1",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder for deadline check
            error_message="Report may be late - T+1 deadline applies.",
            affected_fields=["6"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR014",
            name="Counterparties Different",
            description="Reporting and non-reporting counterparty must be different",
            severity="ERROR",
            rule_type="cross_field",
            expression="record.get('Reporting Entity LEI') != record.get('Non-Reporting Counterparty LEI')",
            error_message="Reporting and non-reporting counterparty cannot be the same.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="CFTC-VR015",
            name="Prior USI for Lifecycle Events",
            description="Prior USI required for MODI, CORR, TERM actions",
            severity="ERROR",
            rule_type="cross_field",
            expression="record['Action Type'] not in ['MODI', 'CORR', 'TERM'] or record.get('Prior USI')",
            error_message="Prior USI required for lifecycle events.",
            affected_fields=["5"],
        ),
    ]

    return RegulationPackage(
        package_id="cftc-2024",
        regulation_code="CFTC",
        regulation_name="CFTC Swap Data Reporting",
        version="3.2 2024",
        effective_date="2024-01-29",
        description="CFTC swap data reporting under Part 43 (real-time) and Part 45 (regulatory). Includes UPI requirement.",
        jurisdiction="US",
        reporting_authority="CFTC",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:cftc:swap:data:reporting",
        output_namespace="urn:cftc:swap:data:reporting",
        output_root_element="SwapDataReport",
        tags=["derivatives", "swaps", "otc", "cftc", "us", "upi"],
    )


# === UK EMIR Package ===

def create_uk_emir_package() -> RegulationPackage:
    """Create UK EMIR regulation package (post-Brexit)."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Report Submitting Entity ID",
            description="LEI of the entity submitting the report",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptSubmitgNtty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Reporting Counterparty ID",
            description="LEI of the reporting counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgCtrPty",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="UnqTxIdr",
            validation_rules=["valid_uti"],
        ),
        FieldSpec(
            field_id="4",
            field_name="Action Type",
            description="Type of action",
            data_type=FieldDataType.ENUM,
            requirement=FieldRequirement.MANDATORY,
            enum_values=["NEWT", "MODI", "CORR", "TERM", "EROR", "REVI", "VALU", "POSC", "MARU"],
            canonical_path="transaction_type",
            xml_element="ActnTp",
        ),
        FieldSpec(
            field_id="5",
            field_name="Notional Amount",
            description="Notional amount",
            data_type=FieldDataType.DECIMAL,
            requirement=FieldRequirement.MANDATORY,
            canonical_path="product.notional_amount",
            xml_element="NtnlAmt",
        ),
        FieldSpec(
            field_id="6",
            field_name="Notional Currency",
            description="Currency of notional",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=3,
            canonical_path="product.notional_currency",
            xml_element="NtnlCcy",
            validation_rules=["valid_currency"],
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="UKEMIR-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR002",
            name="LEI Checksum Validation",
            description="LEI must pass MOD 97-10 checksum",
            severity="ERROR",
            rule_type="format",
            expression="lei_checksum_valid(value)",
            error_message="LEI checksum validation failed.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR003",
            name="UTI Format Validation",
            description="UTI must be 1-52 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR004",
            name="Positive Notional",
            description="Notional amount must be positive",
            severity="ERROR",
            rule_type="business",
            expression="float(record['Notional Amount']) > 0",
            error_message="Notional amount must be positive.",
            affected_fields=["5"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR005",
            name="Currency Code Validation",
            description="Currency must be valid ISO 4217",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z]{3}$', value) is not None",
            error_message="Invalid currency code.",
            affected_fields=["6"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR006",
            name="Valid Action Type",
            description="Action type must be valid UK EMIR code",
            severity="ERROR",
            rule_type="enum",
            expression="record.get('Action Type') in ['NEWT', 'MODI', 'CORR', 'TERM', 'EROR', 'REVI', 'VALU', 'POSC', 'MARU']",
            error_message="Invalid action type.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="UKEMIR-VR007",
            name="UK TR Submission",
            description="Reports must be submitted to UK-registered TR",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder
            error_message="Ensure submission to FCA-registered Trade Repository.",
            affected_fields=["1"],
        ),
    ]

    return RegulationPackage(
        package_id="uk-emir-2024",
        regulation_code="UKEMIR",
        regulation_name="UK European Market Infrastructure Regulation",
        version="UK EMIR 2024",
        effective_date="2024-09-30",
        description="UK EMIR REFIT derivative reporting requirements post-Brexit. Reports to FCA-registered Trade Repositories.",
        jurisdiction="UK",
        reporting_authority="FCA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:iso:std:iso:20022:tech:xsd:auth.030.001.03",
        output_namespace="urn:iso:std:iso:20022:tech:xsd:auth.030.001.03",
        output_root_element="Document",
        tags=["derivatives", "otc", "uk-emir", "fca", "uk"],
    )


# === ASIC Package (Australia) ===

def create_asic_package() -> RegulationPackage:
    """Create ASIC OTC Derivatives Reporting package."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity LEI",
            description="LEI of the reporting entity",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgNttyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Counterparty LEI",
            description="LEI of the counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            canonical_path="parties.other_counterparty.lei",
            xml_element="CtrPtyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="UTI",
            validation_rules=["valid_uti"],
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="ASIC-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="ASIC-VR002",
            name="UTI Format Validation",
            description="UTI must be valid format",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="ASIC-VR003",
            name="Australian Nexus Required",
            description="At least one party must have Australian nexus",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder
            error_message="Verify Australian nexus requirement.",
            affected_fields=["1", "2"],
        ),
    ]

    return RegulationPackage(
        package_id="asic-2024",
        regulation_code="ASIC",
        regulation_name="ASIC OTC Derivatives Reporting",
        version="Rules 2024",
        effective_date="2024-10-21",
        description="Australian OTC derivatives transaction reporting to ASIC-licensed trade repositories.",
        jurisdiction="AU",
        reporting_authority="ASIC",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:asic:otc:derivatives",
        output_namespace="urn:asic:otc:derivatives",
        output_root_element="DerivativesReport",
        tags=["derivatives", "otc", "asic", "australia", "apac"],
    )


# === MAS Package (Singapore) ===

def create_mas_package() -> RegulationPackage:
    """Create MAS OTC Derivatives Reporting package."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity LEI",
            description="LEI of the reporting entity",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgNttyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Counterparty LEI",
            description="LEI of the counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            canonical_path="parties.other_counterparty.lei",
            xml_element="CtrPtyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="UTI",
            validation_rules=["valid_uti"],
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="MAS-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="MAS-VR002",
            name="UTI Format Validation",
            description="UTI must be valid format",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="MAS-VR003",
            name="Singapore Nexus Required",
            description="At least one party must be Singapore-connected",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder
            error_message="Verify Singapore nexus requirement.",
            affected_fields=["1", "2"],
        ),
    ]

    return RegulationPackage(
        package_id="mas-2024",
        regulation_code="MAS",
        regulation_name="MAS OTC Derivatives Reporting",
        version="2024",
        effective_date="2024-01-01",
        description="Singapore OTC derivatives reporting requirements under MAS regulations.",
        jurisdiction="SG",
        reporting_authority="MAS",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:mas:otc:derivatives",
        output_namespace="urn:mas:otc:derivatives",
        output_root_element="DerivativesReport",
        tags=["derivatives", "otc", "mas", "singapore", "apac"],
    )


# === HKMA Package (Hong Kong) ===

def create_hkma_package() -> RegulationPackage:
    """Create HKMA OTC Derivatives Reporting package."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity LEI",
            description="LEI of the reporting entity",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgNttyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Counterparty LEI",
            description="LEI of the counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            canonical_path="parties.other_counterparty.lei",
            xml_element="CtrPtyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="UTI",
            validation_rules=["valid_uti"],
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="HKMA-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="HKMA-VR002",
            name="UTI Format Validation",
            description="UTI must be valid format",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="HKMA-VR003",
            name="Hong Kong Nexus Required",
            description="At least one party must be HK incorporated or have HK business",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder
            error_message="Verify Hong Kong nexus requirement.",
            affected_fields=["1", "2"],
        ),
    ]

    return RegulationPackage(
        package_id="hkma-2024",
        regulation_code="HKMA",
        regulation_name="HKMA OTC Derivatives Reporting",
        version="2024",
        effective_date="2024-01-01",
        description="Hong Kong OTC derivatives reporting to HKTR under HKMA regulations.",
        jurisdiction="HK",
        reporting_authority="HKMA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:hkma:otc:derivatives",
        output_namespace="urn:hkma:otc:derivatives",
        output_root_element="DerivativesReport",
        tags=["derivatives", "otc", "hkma", "hong_kong", "apac"],
    )


# === JFSA Package (Japan) ===

def create_jfsa_package() -> RegulationPackage:
    """Create JFSA OTC Derivatives Reporting package."""

    fields = [
        FieldSpec(
            field_id="1",
            field_name="Reporting Entity LEI",
            description="LEI of the reporting entity",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            pattern=r"^[A-Z0-9]{20}$",
            canonical_path="parties.reporting_counterparty.lei",
            xml_element="RptgNttyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="2",
            field_name="Counterparty LEI",
            description="LEI of the counterparty",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=20,
            canonical_path="parties.other_counterparty.lei",
            xml_element="CtrPtyLEI",
            validation_rules=["valid_lei"],
        ),
        FieldSpec(
            field_id="3",
            field_name="UTI",
            description="Unique Transaction Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=52,
            canonical_path="uti",
            xml_element="UTI",
            validation_rules=["valid_uti"],
        ),
        FieldSpec(
            field_id="4",
            field_name="UPI",
            description="Unique Product Identifier",
            data_type=FieldDataType.STRING,
            requirement=FieldRequirement.MANDATORY,
            max_length=12,
            canonical_path="product.upi",
            xml_element="UPI",
            validation_rules=["valid_upi"],
        ),
    ]

    validation_rules = [
        ValidationRuleSpec(
            rule_id="JFSA-VR001",
            name="LEI Format Validation",
            description="LEI must be 20 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{20}$', value) is not None",
            error_message="Invalid LEI format.",
            affected_fields=["1", "2"],
        ),
        ValidationRuleSpec(
            rule_id="JFSA-VR002",
            name="UTI Format Validation",
            description="UTI must be valid format",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Za-z0-9]{1,52}$', value) is not None",
            error_message="Invalid UTI format.",
            affected_fields=["3"],
        ),
        ValidationRuleSpec(
            rule_id="JFSA-VR003",
            name="UPI Format Validation",
            description="UPI must be 12 alphanumeric characters",
            severity="ERROR",
            rule_type="format",
            expression="re.match(r'^[A-Z0-9]{12}$', value) is not None",
            error_message="Invalid UPI format.",
            affected_fields=["4"],
        ),
        ValidationRuleSpec(
            rule_id="JFSA-VR004",
            name="Japan Nexus Required",
            description="At least one party must be Japan-connected",
            severity="WARNING",
            rule_type="business",
            expression="True",  # Placeholder
            error_message="Verify Japan nexus requirement.",
            affected_fields=["1", "2"],
        ),
    ]

    return RegulationPackage(
        package_id="jfsa-2024",
        regulation_code="JFSA",
        regulation_name="JFSA OTC Derivatives Reporting",
        version="2024",
        effective_date="2024-04-01",
        description="Japanese OTC derivatives reporting to JFSA-registered trade repositories.",
        jurisdiction="JP",
        reporting_authority="JFSA",
        fields=fields,
        validation_rules=validation_rules,
        output_format="XML",
        output_schema="urn:jfsa:otc:derivatives",
        output_namespace="urn:jfsa:otc:derivatives",
        output_root_element="DerivativesReport",
        tags=["derivatives", "otc", "jfsa", "japan", "apac"],
    )


# === Package Registry ===

class RegulationPackageRegistry:
    """Registry for regulation packages."""

    _packages: Dict[str, RegulationPackage] = {}
    _initialized: bool = False

    @classmethod
    def initialize(cls):
        """Initialize the registry with built-in packages."""
        if cls._initialized:
            return

        # Register EU built-in packages
        emir = create_emir_package()
        mifir = create_mifir_package()
        sftr = create_sftr_package()

        # Register US package
        cftc = create_cftc_package()

        # Register UK package
        uk_emir = create_uk_emir_package()

        # Register APAC packages
        asic = create_asic_package()
        mas = create_mas_package()
        hkma = create_hkma_package()
        jfsa = create_jfsa_package()

        # Register all packages by package ID
        cls._packages[emir.package_id] = emir
        cls._packages[mifir.package_id] = mifir
        cls._packages[sftr.package_id] = sftr
        cls._packages[cftc.package_id] = cftc
        cls._packages[uk_emir.package_id] = uk_emir
        cls._packages[asic.package_id] = asic
        cls._packages[mas.package_id] = mas
        cls._packages[hkma.package_id] = hkma
        cls._packages[jfsa.package_id] = jfsa

        # Also register by regulation code for convenience
        cls._packages["EMIR"] = emir
        cls._packages["MIFIR"] = mifir
        cls._packages["SFTR"] = sftr
        cls._packages["CFTC"] = cftc
        cls._packages["UKEMIR"] = uk_emir
        cls._packages["UK-EMIR"] = uk_emir
        cls._packages["ASIC"] = asic
        cls._packages["MAS"] = mas
        cls._packages["HKMA"] = hkma
        cls._packages["JFSA"] = jfsa

        cls._initialized = True
        logger.info(f"Initialized regulation package registry with {len(cls._packages)} packages")

    @classmethod
    def get_package(cls, package_id: str) -> Optional[RegulationPackage]:
        """Get a package by ID or regulation code."""
        cls.initialize()
        return cls._packages.get(package_id.upper()) or cls._packages.get(package_id)

    @classmethod
    def list_packages(cls) -> List[dict]:
        """List all available packages (summaries only)."""
        cls.initialize()
        seen = set()
        summaries = []
        for pkg in cls._packages.values():
            if pkg.package_id not in seen:
                summaries.append(pkg.get_summary())
                seen.add(pkg.package_id)
        return summaries

    @classmethod
    def get_package_by_regulation(cls, regulation_code: str) -> Optional[RegulationPackage]:
        """Get a package by regulation code."""
        cls.initialize()
        return cls._packages.get(regulation_code.upper())

    @classmethod
    def register_package(cls, package: RegulationPackage):
        """Register a custom package."""
        cls.initialize()
        cls._packages[package.package_id] = package
        cls._packages[package.regulation_code.upper()] = package
        logger.info(f"Registered custom package: {package.package_id}")
