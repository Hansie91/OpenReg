name: SBOM Generation

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      verify_licenses:
        description: 'Verify licenses against policy'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install cyclonedx-bom pip-licenses liccheck

      - name: Install Node dependencies
        run: |
          cd frontend
          npm ci

      - name: Generate SBOMs
        run: |
          python scripts/generate_sbom.py \
            --output-dir sbom \
            ${{ github.event.inputs.verify_licenses == 'true' && '--verify-licenses' || '' }}

      - name: Verify Python licenses
        if: github.event.inputs.verify_licenses == 'true' || github.event_name == 'release'
        run: |
          cd backend
          liccheck -s liccheck.ini -r requirements.txt

      - name: Verify Frontend licenses
        if: github.event.inputs.verify_licenses == 'true' || github.event_name == 'release'
        run: |
          cd frontend
          npx license-checker --production --onlyAllow "MIT;BSD-2-Clause;BSD-3-Clause;Apache-2.0;ISC;0BSD;Unlicense;CC0-1.0;Python-2.0"

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom/
          retention-days: 90

      - name: Attach SBOMs to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            sbom/sbom-backend.json
            sbom/sbom-frontend.json
            sbom/licenses-backend.json
            sbom/manifest.json

  license-report:
    name: License Summary
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom/

      - name: Generate license summary
        run: |
          echo "## SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -la sbom/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f sbom/manifest.json ]; then
            echo "### Manifest" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat sbom/manifest.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f sbom/licenses-backend.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Python Dependencies" >> $GITHUB_STEP_SUMMARY
            PYTHON_COUNT=$(jq length sbom/licenses-backend.json 2>/dev/null || echo "?")
            echo "Total packages: $PYTHON_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
